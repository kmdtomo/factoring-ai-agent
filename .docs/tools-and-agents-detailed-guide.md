# ファクタリング審査システム 動作ガイド

## 🎯 システムの全体像

このシステムは、ファクタリング申請の審査を自動化するAIシステムです。
3つのフェーズに分かれており、それぞれが独立して動作します。

```
📄 申請書類
    ↓
[Phase 1A: OCR Heavy] → 重い画像処理（買取情報、通帳）
[Phase 1B: OCR Light] → 軽い画像処理（身分証、登記簿）+ 取引分析
    ↓
[Phase 2: 外部調査] → 代表者・企業の信用情報を調査
    ↓
[Phase 3: 総合判定] → 全データを基にリスク評価
    ↓
✅ 審査結果
```

### ⚠️ 重要な設計思想
- **Phase 1-2は事実収集のみ**（良い/悪いの判断はしない）
- **Phase 3だけが評価・判断**を行う
- **各ツールは生データを返す**（AI判断は最小限）

---

## 📋 Phase 1A: 書類OCR（重い処理）

### 🤖 Phase 1A OCR Heavy Agent
**役割**: 画像処理が重い書類（買取情報、通帳など）をOCR処理

### 🛠️ Phase 1A Heavy ツール一覧

#### 1️⃣ **ocr-purchase-simple-tool**
**何をする**: 買取希望情報を読み取り、期待値と照合
```
対象フィールド: 成因証書＿添付ファイル
処理ファイル数: 最大3ファイル
ファイルタイプ: 制限なし（PDF/画像すべて対応）
サイズ制限: なし
↓
読み取る情報:
- 申込者企業名（請求元）
- 支払者企業名（請求先）  
- 総債権額
↓
照合処理:
- Kintoneの期待値と比較
- match/mismatch/not_foundで判定
```

#### 2️⃣ **ocr-bank-statement-tool**
**何をする**: メイン通帳から入金履歴を分析
```
対象フィールド: メイン通帳＿添付ファイル
処理ファイル数: 最大3ファイル
ファイルタイプ: 制限なし（PDF/画像すべて対応）
サイズ制限: なし
↓
処理モード:
1. マーク検出モード
   - 蛍光ペンでマークされた取引を優先抽出
   
2. 検索モード
   - 主要な入金取引を全て抽出
↓
読み取る情報:
- 取引日付
- 取引金額
- 振込人名
- 取引内容
↓
照合:
- 請求書の支払いと突合
```

#### 3️⃣ **ocr-personal-bank-tool**
**何をする**: 個人通帳からリスク要因を検出
```
対象フィールド: その他通帳＿添付ファイル
処理ファイル数: 最大3ファイル
ファイルタイプ: 制限なし（PDF/画像すべて対応）
サイズ制限: なし
↓
分析内容:
- マークされた取引の抽出
- リスクパターンの検出
  * ギャンブル関連（パチンコ、競馬等）
  * 大口現金引き出し
  * 異常な取引パターン
↓
出力:
- 口座名義人
- 検出されたリスク取引
- 注目すべき発見事項
```

---

## 📑 Phase 1B: 軽い処理と分析

### 🤖 Phase 1B OCR Light Agent
**役割**: 画像処理が軽い書類のOCR + 支払い分析を実行

### 🛠️ Phase 1B Light ツール一覧

#### 4️⃣ **ocr-identity-v2-tool**
**何をする**: 身分証明書を読み取る
```
対象フィールド: 顧客情報＿添付ファイル
処理ファイル数: 累計1.2MBまで（通常1-3ファイル）
ファイルタイプ: 制限なし（PDF/画像すべて対応）
サイズ制限: 全ファイル合計1.2MB
↓
対応書類:
- 運転免許証
- パスポート
- マイナンバーカード
- 在留カード
↓
読み取る情報:
- 氏名
- 生年月日
- 住所（部屋番号まで）
- 免許証の場合:
  * 色（ゴールド/ブルー/グリーン）
  * 有効期限
  * 違反回数
```

#### 5️⃣ **ocr-registry-v2-tool**
**何をする**: 登記簿謄本を読み取る
```
対象フィールド: 複数フィールドから検索
  - 成因証書＿添付ファイル
  - 顧客情報＿添付ファイル
  - 担保情報＿添付ファイル
処理条件: ファイル名に「登記」「謄本」「債権譲渡」を含む
処理ファイル数: 最大3ファイル（フィルタ後）
ファイルタイプ: 制限なし（PDF/画像すべて対応）
サイズ制限: なし
↓
処理内容:
1. 法人登記簿
   - 会社名
   - 設立年月日
   - 資本金
   - 代表者名
   
2. 債権譲渡登記
   - 譲渡の有無を確認
↓
照合:
- 申込企業、買取先、担保企業と突合
- 各企業の存在確認
```

---

### 🛠️ Phase 1B 分析ツール（同じエージェント内で実行）

#### 6️⃣ **payment-analysis-v2-tool**
**何をする**: 支払いデータから統計的事実を抽出
```
抽出する事実データ:

1. 買取情報
   - 掛目率（買取額 ÷ 債権額）
   - 各企業別の掛目率
   - 買取総額、債権総額

2. 担保情報
   - カバー率（次回入金額 ÷ 買取額）
   - 最大入金予定企業とその割合
   - 各企業の支払い実績:
     * 過去3ヶ月の支払い額
     * 平均値と標準偏差
     * 変動係数（ばらつきの指標）

3. 統計サマリー
   - 取引企業数
   - 支払い履歴のある/ない企業数
   - 全体の平均支払い額
   - 全体の支払い変動率
```

---

## 🔍 Phase 2: 外部調査

### 🤖 Phase 2 Research Agent
**役割**: recordIdだけで代表者と企業の信用調査を実行

**動作の流れ**:
```
1. fraudSiteSearchTool(recordId) 
   → 代表者の詐欺情報を調査
   
2. companyVerifyAITool(recordId)
   → 企業の実在性を調査
   
3. 結果を統合して報告（判断なし）
```

### 🛠️ Phase 2 ツール

#### 1️⃣ **fraud-site-search-tool**
**何をする**: 代表者の詐欺情報を検索

**動作詳細**:
```
入力: recordId
↓
1. Kintoneから代表者名を取得
   API: /k/v1/records.json?app=37&query=$id="${recordId}"
↓
2. 詐欺サイト検索
   Google: site:eradicationofblackmoneyscammers.com "代表者名"
↓
3. ネガティブワード検索
   Google: "代表者名 詐欺" (3件)
   Google: "代表者名 逮捕" (3件)
↓
出力: 検索結果の生データ
```

#### 2️⃣ **company-verify-ai-tool**
**何をする**: 企業の公式サイトと実在性を確認

**動作詳細**:
```
入力: recordId
↓
1. Kintoneからデータ取得
   - 会社名（会社_屋号名 or 屋号）
   - 業種
   - 会社所在地
   - 自宅所在地（会社所在地がない場合の代替）
↓
2. 検索クエリ構築
   ケース1: 業種あり
   → "会社名 業種 HP" (例: "山田建設 建設業 HP")
   
   ケース2: 業種なし
   → "会社名 HP"
   
   追加クエリ: 所在地あり
   → "会社名 所在地 HP" (例: "山田建設 福島県 HP")
↓
3. 各クエリでGoogle検索（各3件）
↓
出力: 
- 会社名、所在地情報
- 検索結果の生データ
```

**🔍 所在地の優先順位**:
1. 会社所在地があれば → それを使用
2. 会社所在地がなければ → 自宅所在地を使用（個人事業主対応）

---

## 🎯 Phase 2エージェントの判定ロジック

### 詐欺情報の判定
```
✅ あり: 
- 詐欺サイトに名前が掲載
- ネガティブ検索で具体的事件がヒット

❌ なし:
- 上記に該当しない
```

### 企業実在性の判定
```
🏢 公式サイト「あり」の条件:
- 会社名を含むドメイン（yamada-kensetsu.co.jp等）
- タイトルに「公式」「オフィシャル」
- ❌ 求人サイト、地図サイト、SNSは除外

🏭 企業実在性「あり」の条件:
- 公式サイトがある
- または以下で確認:
  * 建設業許可業者名簿
  * 経営事項審査結果
  * 商工会議所
  * 自治体の入札情報
  * 取引先での言及
  
📍 地域の考慮:
- 会社所在地なし → 自宅所在地と照合
- 通勤可能範囲（1-2時間）= 同一企業の可能性
```

---

## 📊 Phase 3: 総合分析

### 🤖 Phase 3 Analysis Agent
**役割**: 全フェーズのデータから総合的なリスク評価

**評価項目**:
- Phase 1A: 書類の整合性チェック
- Phase 1B: 支払い実績データを基にした評価
  * 掛目率から買取リスクを判定
  * カバー率から回収リスクを判定
  * 変動係数から支払い安定性を判定
- Phase 2: 信用情報の評価
  * 詐欺情報の有無
  * 企業実在性（公式サイトがあれば加点）
↓
**リスクレベル判定**: 低・中・高
**スコアリング**: 各項目を点数化して総合評価

---

## 💡 動作確認のポイント

### Phase 1の動作確認例

**実行フロー**
```
Phase 1A (OCR Heavy Agent):
1. ocr-purchase-simple-tool → 買取情報の読み取り・照合
2. ocr-bank-statement-tool → メイン通帳の分析
3. ocr-personal-bank-tool → 個人通帳のリスク検出

Phase 1B (OCR Light Agent):
1. ocr-identity-v2-tool → 身分証の読み取り
2. ocr-registry-v2-tool → 登記簿の読み取り
3. payment-analysis-v2-tool → 支払いデータの統計分析
```

**注意**: `phase1-ocr-agent`は使用されていません。
処理負荷を分散するため、Phase 1AとPhase 1Bに分割されています。

### Phase 2の動作確認例

**テストケース1: 正常な企業**
```
recordId: "10036"
期待される動作:
1. fraudSiteSearchTool
   - Kintoneから「飯島亮佑」を取得
   - 詐欺サイト検索 → 0件
   - ネガティブ検索 → 関係ない結果

2. companyVerifyAITool  
   - 「ＭＩＲＡＩ組株式会社」「建設業」を取得
   - "ＭＩＲＡＩ組株式会社 建設業 HP" → 検索
   - 実在性: 建設業許可で確認
```

**テストケース2: 個人事業主**
```
会社所在地: なし
自宅所在地: 埼玉県
期待される動作:
- "会社名 埼玉県 HP" で検索（自宅所在地を使用）
```

---

## 🚨 トラブルシューティング

### よくある問題

**問題1**: OCRの精度が低い
```
原因: 画像品質が悪い
解決: 
- 高解像度での再スキャン
- マーク検出モードの活用
```

**問題2**: Phase 2エージェントが何度も同じツールを実行する
```
原因: ツールの役割を誤解
解決: recordIdだけ渡せば自動で全て処理される
```

**問題3**: 個人事業主の企業が見つからない
```
原因: 会社所在地がない
解決: 自動的に自宅所在地で検索される
```

**問題4**: 総合判断が出力に含まれる
```
原因: Phase 2で評価してしまっている
解決: Phase 2は事実のみ、評価はPhase 3
```

---

## 📈 パフォーマンス最適化

### API使用量
- **Google検索**: 1クエリ3件まで
- **Phase 2合計**: 最大4クエリ（12件）
- **Claude API**: 
  - OCR: 各ツールで1回
  - エージェント: 統合時に1回

### コスト削減済み項目
- ✅ ネガティブワード検索を4→2に削減
- ✅ 検索結果を10→3件に削減  
- ✅ ツールでのAI判断を廃止
- ✅ 詳細説明を削除（生データのみ）

---

## 📝 Kintoneフィールド対応表

### レコード情報（app=37）
| フィールド名 | 用途 |
|------------|------|
| 会社_屋号名 | 申込企業名 |
| 代表者名 | 詐欺情報検索 |
| 会社所在地 | 企業検索（優先） |
| 自宅所在地 | 企業検索（代替） |
| 業種 | 企業検索クエリ |

### 添付ファイルフィールド
| フィールド名 | OCRツール | 実行Phase |
|------------|-----------|-----------|
| 成因証書＿添付ファイル | ocr-purchase-simple | Phase 1A |
| メイン通帳＿添付ファイル | ocr-bank-statement | Phase 1A |
| その他通帳＿添付ファイル | ocr-personal-bank | Phase 1A |
| 顧客情報＿添付ファイル | ocr-identity-v2 | Phase 1B |
| 登記簿＿添付ファイル | ocr-registry-v2 | Phase 1B |

### エージェント構成
| エージェント名 | 使用状況 | 役割 |
|------------|---------|------|
| phase1-ocr-agent | ❌ 未使用 | 元々の統合OCRエージェント |
| phase1a-ocr-heavy-agent | ✅ 使用中 | 重い画像処理（買取・通帳） |
| phase1b-ocr-light-agent | ✅ 使用中 | 軽い画像処理（身分証・登記簿）+ 分析 |
| phase2-research-agent | ✅ 使用中 | 外部調査（詐欺・企業実在性） |
| phase3-analysis-agent | ✅ 使用中 | 総合評価・リスク判定 |