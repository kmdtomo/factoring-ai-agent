# 内部ツール構造・判断ロジック仕様書

## 概要
このドキュメントは、現在使用中のOCRツール群の内部構造、判断ロジック、ファイル処理方法を詳細に記録したものです。

---

## 🔧 OCRツール一覧

### 1. ocrPurchaseSimpleTool
**目的**: 買取関連書類（請求書・発注書）の基本情報抽出

#### 📁 ファイル処理ロジック
- **対象ファイル**: `成因証書＿添付ファイル` フィールドから取得
- **処理ファイル数**: 上位3ファイル（バッチ処理対応）
- **ファイル形式**: PDF、画像ファイル（JPEG、PNG、GIF、WebP）
- **スキップ条件**: 
  - 明らかに買取・請求書と関係ないファイル（個人写真、メモ等）
  - AIが内容を確認して判断（ファイル名ではなく内容ベース）

#### 🎯 抽出項目
- **申込者企業名** (requestorCompany)
- **支払者企業名** (payerCompany)  
- **請求書合計金額** (totalAmount)
- **支払期日** (paymentDueDate)
- **請求書番号** (invoiceNumbers)

#### 🔍 照合ロジック
- **期待値取得元**: Kintoneデータ
  - `買取情報.会社名_第三債務者_買取` → 申込者企業
  - `基本情報.屋号` → 支払者企業
  - `買取情報.総債権額` → 総金額
- **照合方式**: 完全一致判定
- **文書分類**: 請求書 vs 発注書を自動判別
  - 請求書: 金額を合計に含める
  - 発注書: 取引証明として扱うが金額は除外

#### 🚀 汎用性設計
- **企業名照合**: 部分一致・表記ゆれ対応
- **金額抽出**: カンマ区切り数字の正確な読み取り
- **文書混在対応**: 1ファイル内に複数文書がある場合の適切な分類

---

### 2. ocrBankStatementTool
**目的**: メイン通帳（会社口座）の入金取引と期待値との照合

#### 📁 ファイル処理ロジック
- **対象ファイル**: `通帳＿添付ファイル` フィールドから取得
- **処理ファイル数**: 上位1ファイル（大容量画像対応）
- **ファイル形式**: PDF、画像ファイル
- **スキップ条件**: 明らかに通帳でないファイル

#### 🎯 抽出項目
- **入金取引一覧** (extractedTransactions)
  - 入金額（整数）
  - 日付
  - 摘要・振込元
- **照合結果** (matchResults)
  - 期待値との完全一致判定
  - 一致した企業と期間

#### 🔍 照合ロジック
- **期待値取得元**: `担保情報` テーブル
  - 各企業の過去3回分の入金額
  - 企業名: 入金額配列のマッピング
- **照合方式**: 統合モード（マーク検出 + 適応的抽出）
  - **マーク有り**: 視覚的マークを基準に抽出
  - **マーク無し**: 全入金取引から期待値と一致するものを検索
- **数字認識**: 8/3、9/0、6/5の混同対策プロンプト

#### 🚀 汎用性設計
- **企業数対応**: 動的な企業数に対応（1社〜複数社）
- **期間対応**: 過去3回分の入金額パターン
- **マーク対応**: マーク有無の自動判別と適応的処理

---

### 3. ocrPersonalBankTool
**目的**: 個人口座（その他通帳）の使途パターン分析

#### 📁 ファイル処理ロジック
- **対象ファイル**: `その他通帳＿添付ファイル` フィールドから取得
- **処理ファイル数**: 上位3ファイル
- **ファイル形式**: PDF、画像ファイル
- **スキップ条件**: 明らかに個人口座でないファイル

#### 🎯 抽出項目
- **口座情報** (accountHolder, bankName)
- **分析期間** (analysisMonths)
- **特徴的取引** (notableTransactions)
- **使途分析** (usageSummary)
  - 娯楽・レジャー関連
  - 事業関連
  - 現金使用
  - その他特徴的使途
- **総括** (summary)

#### 🔍 分析ロジック
- **事実ベース分析**: リスク評価ではなく客観的事実の報告
- **重要度判定**: AIが頻度・金額・取引先を総合判断
- **使途分類**: 自動的なカテゴリ分類
- **パターン抽出**: 特徴的な取引パターンの特定

#### 🚀 汎用性設計
- **使途中立性**: ギャンブル等でも事実として報告
- **重要度自動判定**: 手動指定なしでAIが重要取引を選別
- **カテゴリ柔軟性**: 固定カテゴリではなく動的分類

---

### 4. ocrIdentityToolV2
**目的**: 本人確認書類の情報抽出

#### 📁 ファイル処理ロジック
- **対象ファイル**: `顧客情報＿添付ファイル` フィールドから取得
- **処理ファイル数**: 全ファイル（スライスなし）
- **ファイル形式**: PDF、画像ファイル
- **スキップ条件**: 明らかに本人確認書類でないファイル

#### 🎯 抽出項目
- **代表者情報** (representativeInfo)
  - 氏名、住所、生年月日
- **会社情報** (companyInfo)
  - 会社名、住所
- **書類種別** (documentType)
- **信頼度** (confidence)

#### 🔍 照合ロジック
- **Kintone照合**: 基本情報テーブルとの照合
- **表記ゆれ対応**: 住所・氏名の表記違い対応
- **複数書類対応**: 運転免許証、パスポート等の自動判別

---

### 5. ocrRegistryToolV2
**目的**: 登記簿謄本の企業情報抽出

#### 📁 ファイル処理ロジック
- **対象ファイル**: 複数フィールドから検索
  - `成因証書＿添付ファイル`
  - `顧客情報＿添付ファイル`  
  - `担保情報＿添付ファイル`
- **処理ファイル数**: 全ファイル
- **ファイル形式**: PDF、画像ファイル
- **スキップ条件**: 明らかに登記簿でないファイル

#### 🎯 抽出項目
- **企業基本情報** (companyInfo)
  - 設立年月日、資本金、代表者
- **企業種別** (companyType)
  - 買取、申込者、担保の役割分類
- **登記情報** (registryInfo)
  - 債権譲渡登記の有無
- **信頼度** (confidence)

#### 🔍 照合ロジック
- **多フィールド検索**: 3つの添付ファイルフィールドを横断検索
- **企業種別判定**: 文脈から企業の役割を自動判定
- **登記情報確認**: 債権譲渡登記の有無を確認

---

## 🔄 共通処理ロジック

### ファイル取得・変換
```typescript
// 共通のファイル処理パターン
const base64Content = Buffer.from(fileResponse.data).toString('base64');
const isPDF = file.contentType === 'application/pdf';
const dataUrl = isPDF 
  ? `data:application/pdf;base64,${base64Content}`
  : `data:${file.contentType};base64,${base64Content}`;
```

### OpenAI API呼び出し
```typescript
// 統一されたAPI呼び出し形式
const result = await generateObject({
  model: openai("gpt-4o"),
  messages: [
    {
      role: "user",
      content: [
        { type: "text", text: prompt },
        ...base64Images,
      ],
    },
  ],
  schema: z.object({...}),
});
```

### エラーハンドリング
- **ファイル取得失敗**: 空の結果で継続
- **OCR失敗**: エラーメッセージ付きで継続
- **スキップ**: 理由付きでスキップ報告

---

## 🎯 汎用性設計原則

### 1. ファイル処理
- **動的ファイル数**: 固定数ではなく上位N件の処理
- **形式対応**: PDF・画像の両対応
- **内容ベース判定**: ファイル名ではなく内容で関連性判定

### 2. データ照合
- **表記ゆれ対応**: 企業名・住所の表記違い許容
- **部分一致**: 完全一致でなくても関連性判定
- **複数候補**: 複数候補がある場合の優先順位

### 3. エラー処理
- **継続性**: 1つのツール失敗でも全体継続
- **透明性**: エラー理由の明確な報告
- **デバッグ**: 詳細なログ出力

### 4. スケーラビリティ
- **企業数対応**: 1社〜複数社の動的対応
- **文書数対応**: 少ない文書〜大量文書の対応
- **期間対応**: 短期〜長期の期間データ対応

---

## 📊 パフォーマンス考慮

### コンテキスト制限対策
- **ファイル数制限**: 重い処理は1ファイル、軽い処理は3ファイル
- **バッチ処理**: 複数ファイルの一括処理
- **データ圧縮**: 不要な詳細情報の削除

### 処理速度最適化
- **並列禁止**: 順次実行で安定性確保
- **早期終了**: 明らかに無関係なファイルの早期スキップ
- **キャッシュ**: Kintoneデータの効率的取得

---

## 🔧 メンテナンス指針

### プロンプト調整
- **数字認識**: 8/3、9/0、6/5の混同対策
- **表記ゆれ**: 企業名・住所の表記パターン追加
- **文書分類**: 新しい文書タイプの対応

### スキーマ拡張
- **新項目追加**: 業務要件に応じた項目追加
- **バリデーション**: 入力値の妥当性チェック強化
- **型安全性**: TypeScript型定義の充実

### ログ・デバッグ
- **詳細ログ**: 処理過程の可視化
- **エラー追跡**: 失敗原因の特定
- **パフォーマンス**: 処理時間の監視
