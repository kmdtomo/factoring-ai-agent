# ファクタリングAIエージェント概念 v2.0

## 基本方針

### AIの役割定義
- **目的**: ファクタリング審査における定量的データ分析と照合作業の自動化
- **スコープ**: 人間では手間がかかる作業に特化し、主観的判断は人間に委ねる
- **価値**: 属人性の解消 - ベテランの判断軸を手間をかけずに実行可能にする
- **重要**: このAIエージェントはウィット（ファクタリング会社）が使用することを前提に設計されている

### 人間とAIの役割分担
| 領域 | 人間 | AI |
|------|------|-----|
| 所感・印象評価 | ✓ | - |
| 面談内容の判断 | ✓ | - |
| 最終的な承認判断 | ✓ | - |
| データ間の照合 | - | ✓ |
| OCRによる書類読取 | - | ✓ |
| 定量的リスク分析 | - | ✓ |
| パターン認識 | - | ✓ |

## 評価軸の再定義

### 1. 買取情報分析（最重要）
**目的**: 買取債権の妥当性とリスク評価

#### 主要評価指標
- **掛目（かけめ）分析**
  - 計算式: 買取額 ÷ 買取債権額
  - リスク判定:
    - 80%以下: 低リスク ✓
    - 80%超: 高リスク ⚠️
  - 理由: 掛目が高いほど回収不能時の損失リスクが増大

### 2. 担保情報分析（最重要）
**目的**: バックアップとしての回収ルートの確保と継続的な回収可能性の評価

#### 評価の優先順位

##### 第1段階：即時回収能力の評価
- **次回入金予定での担保評価**
  - 各担保企業の「請求額」の合計
  - 買取額との比較（請求額合計 > 買取額 = 担保あり）
  - 特定企業への依存度チェック

##### 第2段階：請求額の信頼性評価
- **過去実績との整合性**
  - 請求額と過去入金平均の比較
  - 乖離が大きい場合は要注意
  - 備考欄の確認（大型案件等の特殊要因）
  
- **企業別信頼性スコア**
  - 過去入金が0円の企業 → 信頼性低
  - 安定した入金実績 → 信頼性高
  - 変動が激しい → 中程度

##### 第3段階：債権種類との紐付け分析
- **買取**: 今回の買取対象企業
- **担保**: 継続的な取引による回収保証
- **買取担保**: 両方の役割（最も価値が高い）

#### リスク判定基準
- **低リスク**: 
  - 1社で買取額全額をカバー可能
  - かつその企業の過去実績が安定
  
- **中リスク**: 
  - 1社依存だが実績あり
  - または複数社合計でカバー
  
- **高リスク**: 
  - 担保不足
  - または主要担保企業の実績が不安定

### 実例による評価プロセス

#### 評価フロー（汎用的な手順）

**第1段階：即時回収能力の評価**
```
1. 買取情報テーブルから買取債権額（合計）を取得
2. 担保情報テーブルから各企業の「請求額」を取得
3. 請求額の合計と買取債権額を比較
   - 請求額合計 ≥ 買取債権額 → 担保あり
   - 請求額合計 < 買取債権額 → 担保不足
```

**第2段階：信頼性評価**
```
各担保企業について：
1. 過去3回の入金実績から平均値を算出
2. 今回の請求額と平均値を比較
3. 備考欄の特殊要因を確認
4. 信頼性を判定：
   - 過去実績なし（平均0円） → 信頼性低
   - 請求額が平均の2倍以上 → 要確認
   - 安定した実績あり → 信頼性高
```

**第3段階：総合判定**
```
1. 買取債権額をカバーできる担保企業数を確認
2. 1社依存の場合はリスク増大
3. 複数社でカバーの場合は分散効果あり
4. 各企業の謄本情報（設立年・資本金）も加味
```

### 3. 謄本情報分析
**目的**: 取引先企業の信用力・安定性の評価

#### 評価基準

##### 会社成立年の評価
- **昭和（〜1989年）**: 優良 ✓✓（35年以上の実績）
- **平成初期（1989-2000年）**: 良好 ✓（20年以上）
- **平成後期（2001-2019年）**: 普通
- **令和（2019年〜）**: 要注意 ⚠️（5年未満）

##### 資本金の評価
- **1,000万円以上**: 優良 ✓✓
- **500万円以上**: 良好 ✓
- **200-500万円**: 普通
- **200万円未満**: 弱い ⚠️

#### 謄本×担保の統合評価

**重要**: 謄本情報と担保情報を連携させて、「しっかりした会社から、安定した入金がある」かを確認

##### 統合評価の例

| 会社名 | 設立 | 資本金 | 謄本評価 | 担保実績 | 統合評価 |
|--------|------|--------|----------|----------|----------|
| 関東エンジニアリング | 昭和63年 | 2,000万円 | 優良✓✓ | 平均190万円 | 信頼できる担保企業 |
| HSI | 平成23年 | 50万円 | 弱い⚠️ | 不安定28万円 | 企業基盤・担保とも不安定 |
| SKS | 令和1年 | 500万円 | 要注意⚠️ | 平均1万円 | 新設企業で実績なし |
| 一角 | 平成28年 | 500万円 | 普通 | 不規則55万円 | 中程度の信頼性 |
| 楢木空調 | 平成18年 | 500万円 | 良好✓ | 実績なし | 企業は安定だが取引実績なし |

##### 判定ロジック
- **優良企業 + 安定担保** = 最も信頼できる
- **優良企業 + 不安定担保** = 企業は良いが取引に課題
- **弱い企業 + 安定担保** = 企業基盤に不安
- **弱い企業 + 不安定担保** = 高リスク

### 4. OCR照合分析（AI特化領域）
**目的**: 書類の真正性確認と各種データとの整合性チェック

#### 基本方針
- **探索型ではなく照合型**: 既知のデータと書類内容を照合
- **3段階評価**: 一致 ✓ / 不一致 ✗ / 確認不能 ?
- **具体的な数値報告**: 「○○円が一致」「××円の相違」

#### 照合プロセス

##### 1. 買取情報書類の照合
**対象**: 請求書、契約書、債権譲渡登記など

```
照合項目：
- 請求先企業名 = 第三債務者名（買取情報テーブル）
- 請求元企業名 = 申込者名（基本情報）
- 請求金額 = 総債権額（買取情報テーブル）
- 支払期日 = 買取債権支払日
```

**重要**: 
- 請求書には「総債権額」が記載される（全体の請求金額）
- 「総債権額」の一部が「買取債権額」としてファクタリング対象になる
- 「買取額」は買取債権額に掛目を適用した実際の買取金額

**評価基準**:
- 請求書の総債権額一致: 必須（不一致はアラート）
- 請求先・請求元の確認: 必須（取引の正当性）
- 債権譲渡登記あり: +5点（信頼性向上）
- 債権譲渡登記なし: -3点（小幅な減点）

##### 2. 通帳OCRによる担保検証
**対象**: メイン通帳、その他通帳

**基本方針**: マーカー・赤丸部分を重点確認（担当者が既に重要と判断）

**通帳の重要度**
- **メイン通帳**: 必須確認（データがない場合は要注意）
- **その他通帳**: 補助的確認（データがなくても問題なし）

**通常パターン（標準的なケース）**
```
照合項目：
- 口座名義 = 申込者名（本人確認）
- マーカー部分 = 担保企業からの入金
- 入金額 = 担保情報テーブルと照合
例：「〇〇企業からX,XXX,XXX円の入金確認」
```

**特殊パターン（担保と無関係な重要情報）**
```
発見項目：
- 他社ファクタリング利用（例：ウィットや他社からの入金）
  - 注意：ウィットは既存のファクタリング会社であり、資金繰りの状況を示す重要な指標
- 異常な入出金パターン
- 資金繰りの状況把握
```

**レポート方針**:
- 必ず「⚠️ 人間による確認を推奨」を明記
- マーカー部分の内容を客観的に報告
- 推測は「可能性」「示唆」という表現に留める
- 担保情報と照合できない場合も、発見事項として報告

##### 3. 本人確認書類の照合
**対象**: 運転免許証、マイナンバーカードなど

**基本照合項目**
```
必須確認：
- 氏名 = 代表者名と完全一致
- 住所 = 登録住所と一致
- 生年月日 = 基本情報と一致
```

**運転免許証の追加評価項目**
```
信頼性指標：
- 免許証の色
  - ゴールド免許：優良（5年無事故無違反）→ +5点
  - ブルー免許：一般 → ±0点
  - グリーン免許：初心者 → -3点

- 違反回数（裏面記載）
  - 0回：優良 → +3点
  - 1-2回：普通 → ±0点
  - 3回以上：要注意 → -5点
```

**評価の根拠**
- ゴールド免許 = 長期的な規則遵守能力の証明
- 違反履歴 = リスク管理意識の指標
- これらは補助的な判断材料として活用

##### 4. 担保情報書類の分析
**対象**: 担保情報（成因証書、謄本類、名刺等）

**特徴**: 内容が統一されておらず、まちまちな書類が混在
- 担保会社の謄本
- 関係会社の取引書類
- その他関連書類

**評価方針**:
- 要件が未確定のため、AIが柔軟に判断
- 発見した情報を客観的に報告
- 担保情報との関連性があれば報告
- 「参考情報」として位置づけ

#### 他評価軸との連携

##### OCR × 買取情報
- 請求書が確認できない → 買取リスク急上昇
- 請求書金額が一致 → 買取情報の信頼性確保
- 複数の請求書で整合性確認 → より強固な証拠

##### OCR × 担保情報
- 通帳で担保企業からの入金確認 → 担保の実在性証明
- 入金額が担保情報と一致 → データの信頼性向上
- 入金パターンの規則性確認 → 将来の回収可能性評価

##### OCR × 謄本情報
- 謄本PDFと登録データの一致確認
- 資本金・設立年の照合
- 代表者名の一致確認

#### レポート形式例

```
【請求書照合結果】
〇〇企業向け請求書（MM/DD締）：
- 請求先：「[第三債務者名]」を確認 [✓/✗/?]
- 請求金額：X,XXX,XXX円が買取情報テーブルの買取債権額と[一致/不一致/確認不能]
- 支払期日：YYYY年MM月DD日（買取債権支払日と[一致/不一致]）
- 照合結果：[具体的な照合結果を記載]

【統合評価】
- 買取情報の信頼性：[高/中/低]（[根拠を記載]）
- 担保の実在性：[確認済み/未確認]（[確認方法を記載]）
- 総合判定：[低/中/高]リスク
```

**通帳分析のレポート形式**
```
【通帳分析結果】
⚠️ 人間による確認を推奨します

マーカー部分の分析：
- X,XXX,XXX円の入金（企業名A）：赤丸でマーク
- Y,YYY,YYY円の入金：赤丸でマーク
- Z,ZZZ,ZZZ円の出金：マーカーで強調

推測される状況：
- [発見した事実を客観的に記載]
- [入出金パターンの特徴を記載]
- [担保情報との照合結果を記載]
- ウィットからの入金がある場合：「他社ファクタリング利用中の可能性」と明記

追加発見事項：
- [口座種別（個人/法人）の確認結果]
- [資金移動パターンの特徴]
```

## 実装アーキテクチャ

### 処理フロー

#### 📊 Phase 1: データ収集（並列実行）
```
同時実行：
├── Kintoneデータ取得
├── エゴサーチ（代表者名検索）
└── 企業実在性確認（会社名検索）
```

#### 🔍 Phase 2: OCR処理（順次実行）
```
1件ずつ処理：
├── ①買取情報書類
│   ├── 請求書1 → 金額・企業名を照合
│   ├── 請求書2 → 金額・企業名を照合
│   └── 債権譲渡登記 → あれば+5点
│
├── ②通帳（メイン）
│   └── マーカー部分を重点確認
│
├── ③通帳（その他）
│   └── あれば追加情報として
│
├── ④顧客情報
│   └── 運転免許証 → 本人確認＋ゴールド免許確認
│
└── ⑥担保情報書類
    └── 内容をAIが柔軟に判断
```

#### 🤖 Phase 3: 統合判定（メインAI）
```
全データを統合して分析：
├── 買取情報 × OCR照合
├── 担保情報 × 通帳確認
├── 謄本情報 × 企業信用力
└── 総合リスク判定 → レポート生成
```

### 実装のポイント

1. **並列処理の活用**
   - Phase 1は完全並列で高速化
   - API制限のないものは同時実行

2. **OCRの制約対応**
   - PDFは1枚ずつ処理（Vision API制限）
   - 照合型の質問で精度向上
   - 必要最小限の情報のみ抽出

3. **エージェントの使い分け**
   - OCR/データ取得：GPT-3.5（コスト削減）
   - 統合判定：GPT-4（高精度判定）

### パフォーマンス目標
- Phase 1: 5秒（並列実行）
- Phase 2: 20-30秒（OCR 5-6枚）
- Phase 3: 5秒（統合判定）
- **合計: 30-40秒**

## スコアリングシステム

### スコア配分（100点満点）

#### 1. 買取情報評価：30点
```
掛目評価：20点
- 80%以下：20点
- 80-85%：10点
- 85%超：0点

請求書照合：10点
- 完全一致：10点
- 不一致：-10点（要確認として報告）
- 確認不能：5点（中立的に報告）
```

#### 2. 担保情報評価：40点（最重要）
```
即時回収能力：20点
- 100%以上カバー：20点
- 80-100%：10点
- 80%未満：0点

入金安定性：20点
- 安定（変動15%以下）：20点
- やや不安定：10点
- 不安定：0点
```

#### 3. 謄本情報評価：20点
```
設立年：10点
- 昭和：10点
- 平成前期：8点
- 平成後期：5点
- 令和：2点

資本金：10点
- 1000万円以上：10点
- 500万円以上：7点
- 200-500万円：3点
- 200万円未満：0点
```

#### 4. 補助評価：10点
```
基本点：10点
加減点項目：
- エゴサーチでネガティブ情報：-5点
- 企業実在性確認できず：-5点
- ゴールド免許：+5点
- グリーン免許：-3点
- 債権譲渡登記あり：+5点
- 債権譲渡登記なし：-3点
- 違反3回以上：-5点
```

### 総合判定基準
```
80点以上：低リスク（承認推奨）
60-79点：中リスク（条件付き承認）
60点未満：高リスク（要再検討）
```

### 特別ルール
- 担保0%の場合は最高でも中リスク判定
- 複数の減点項目が重なった場合は要人間確認
- 書類が不明確な場合は「確認不能」として淡々と事実を報告
- 判断できない書類は無理に評価せず、客観的に記述

## Kintone取得フィールド一覧

### 基本情報
```
- 代表者名
- 生年月日
- 会社_屋号名
- 会社所在地
- 自宅所在地（住所確認用）
```

### 財務・リスク情報
```
- 売上
- 業種
- 資金使途
- ファクタリング利用
- 税金滞納額_0
- 納付状況_税金
- 保険料滞納額
- 納付状況_保険料
```

### 買取情報テーブル
```
- 会社名_第三債務者_買取
- 総債権額（請求書に記載される全体の請求金額）
- 買取債権額（総債権額のうちファクタリング対象となる部分）
- 買取額（ファクタリング会社の実際の買取額）
- 掛目（買取額÷買取債権額）
- 買取債権支払日
- 総債権額（合計）※必須
- 買取債権額（合計）※必須
- 買取額（合計）※必須
```

### 担保情報テーブル
```
- 会社名_第三債務者_担保
- 請求額
- 入金予定日
- 過去の入金_先々月
- 過去の入金_先月
- 過去の入金_今月
- 平均
- 備考（重要情報含む）
```

### 謄本情報テーブル
```
- 会社名_第三債務者_0
- 資本金の額
- 会社成立
- 債権の種類
```

### 添付ファイル（fileKeys取得用）
```
- 買取情報_成因証書_謄本類_名刺等_添付ファイル
- 通帳_メイン_添付ファイル
- 通帳_その他_添付ファイル
- 顧客情報_添付ファイル
- 担保情報_成因証書_謄本類_名刺等_添付ファイル
```

## レポート構成

### 審査サマリー
```
総合スコア：XX/100点
リスクレベル：[低/中/高]
推奨アクション：[承認/条件付き承認/要再検討]
```

### 1. 買取債権評価（30点）
```
├── 掛目分析（20点）
│   ├── 掛目：XX.X%
│   └── 評価：[0/10/20点]
│
├── 請求書照合（10点）
│   ├── 関東エンジニアリング向け
│   │   ├── 金額：一致/不一致/確認不能
│   │   └── 企業名：一致/不一致/確認不能
│   └── その他請求書
│
└── 債権譲渡登記（加減点）
    └── [あり：+5点/なし：-3点]
```

### 2. 担保評価（40点）
```
├── 即時回収能力（20点）
│   ├── 買取額：XXX万円
│   ├── 次回入金予定額：XXX万円
│   ├── カバー率：XX%
│   └── 評価：[0/10/20点]
│
├── 入金安定性（20点）
│   ├── 各企業の入金実績
│   ├── 変動係数：XX%
│   └── 評価：[0/10/20点]
│
└── 通帳照合結果
    ├── マーカー部分の分析
    └── 特記事項（他社ファクタリング利用等）
```

### 3. 企業信用力評価（20点）
```
├── 謄本情報（20点）
│   ├── 設立年評価（10点）
│   ├── 資本金評価（10点）
│   └── 債権種類との整合性
│
└── 補助評価
    ├── エゴサーチ結果
    └── 企業実在性確認
```

### 4. 申込者評価（10点）
```
├── 本人確認
│   ├── 氏名・住所・生年月日：一致/不一致
│   └── 有効期限：OK/期限切れ
│
├── 信頼性指標
│   ├── 免許証の色：[ゴールド/ブルー/グリーン]
│   └── 違反回数：X回
│
└── 評価点：[基本10点 + 加減点]
```

### 特記事項・警告
```
⚠️ 要人間確認事項
- XXXX
- YYYY

📝 追加発見事項
- ZZZZ
```

## ワークフロー実装（v2.2）

### 処理フローの確定版

エージェントベースからワークフローベースへの移行により、処理順序と条件分岐を明確化。

#### Phase 1: 初期データ収集
```
┌─────────────────┐
│ 1. Kintoneデータ取得 │ ← 必須・最優先
└─────────────────┘
```

#### Phase 2: 書類準備とOCR処理（順次実行）
```
┌─────────────────────┐
│ 2. purchaseDataPrep  │ ← 買取情報の準備
└─────────────────────┘
         ↓
┌─────────────────────┐
│ 3. OCR: 請求書      │ ← 買取債権額の照合
└─────────────────────┘
         ↓
┌─────────────────────┐
│ 4. OCR: 通帳(メイン) │ ← 担保情報との照合
└─────────────────────┘
         ↓ 不一致があれば
┌─────────────────────┐
│ 5. 詳細分析ツール    │ ← 分割払い等の分析（オプション）
└─────────────────────┘
         ↓
┌─────────────────────┐
│ 6. OCR: 本人確認書類 │ ← 正確な氏名・住所を取得
└─────────────────────┘
         ↓ OCR結果を使って
┌─────────────────┐  ┌─────────────────┐
│ 7. エゴサーチ      │  │ 8. 企業実在性確認  │
│  (OCRで取得した氏名)│  │  (会社名・住所)   │ ← 並列実行
└─────────────────┘  └─────────────────┘
         ↓
┌─────────────────────┐
│ 9. OCR: 登記簿      │
└─────────────────────┘
         ↓
┌─────────────────────┐
│ 10. OCR: 担保書類   │ ← ファイルが存在する場合のみ
└─────────────────────┘
```

#### Phase 3: 統合分析
```
┌─────────────────────┐
│ 11. paymentAnalysisV2│ ← 全データでスコアリング
└─────────────────────┘
         ↓
┌─────────────────────┐
│ 12. レポート生成     │
└─────────────────────┘
```

### 条件分岐の詳細

#### 1. 通帳OCR後の詳細分析
```typescript
if (bankOCRResult.matchingResults?.matches.some(m => m.matchType === "none")) {
  // 不一致がある場合のみ詳細分析ツールを実行
  await advancedPaymentAnalysisTool.execute({...});
}
```

#### 2. 本人確認書類OCR後の検索
```typescript
if (identityResult.success) {
  // OCR成功時のみエゴサーチと企業実在性確認を実行
  // OCRで取得した正確な情報を使用
}
```

#### 3. オプションファイルの処理
```typescript
if (record.担保情報_添付ファイル?.value?.length > 0) {
  // ファイルが存在する場合のみOCR実行
}
```

### データフローマップ

```
Kintoneデータ
├─→ purchaseDataPrep（総債権額の抽出）
│   └─→ ocrPurchaseInfoTool（請求書照合）
├─→ ocrBankStatementTool（担保情報で照合）
├─→ ocrIdentityTool（代表者名・住所で照合）
│   ├─→ egoSearchTool（OCR結果の氏名で検索）
│   └─→ companyVerifyTool（会社情報で検索）
└─→ paymentAnalysisV2Tool（全データで分析）
```

### エラーハンドリング方針

1. **必須処理（エラー時は中断）**
   - Kintoneデータ取得
   - 請求書OCR（買取情報の照合）
   - メイン通帳OCR（担保の確認）

2. **オプション処理（エラー時も続行）**
   - 詳細分析ツール
   - 担保書類OCR
   - その他通帳OCR

3. **部分的失敗の扱い**
   - 各ツールの結果に`success`フラグ
   - 失敗した項目は0点として処理
   - レポートに「確認不能」として記載

### パフォーマンス最適化

1. **並列実行可能な箇所**
   - Phase 1: 初期3ツール（v2.2では不要）
   - エゴサーチと企業実在性確認
   - 複数OCRの一部（依存関係がない場合）

2. **キャッシュ戦略**
   - Kintoneデータは一度取得後、使い回し
   - OCR結果は再利用可能な形で保存

3. **タイムアウト設定**
   - 各OCR: 30秒
   - 検索系: 15秒
   - 全体: 3分

## 変更履歴

### v2.2 (2025-09-11)
- ワークフロー実装への移行
  - エージェントベースから確定的なワークフローへ
  - 条件分岐とエラーハンドリングの明確化
  - 本人確認書類OCR後に検索を実行するよう変更
- 通帳OCRツールの改善
  - 担保情報との照合機能を追加
  - 分割払いの基本的な検出
  - マーカー検出プロンプトの簡素化

### v2.1 (2025-09-11)
- OCRツールをシンプル化
  - 買取情報OCR: Yes/No形式の照合のみ実施
  - 通帳OCR: マークされた入金リストの抽出のみ
  - 複雑な計算・照合ロジックをエージェントに移管
- エージェントの役割を明確化
  - OCRツールから受け取ったデータの照合
  - 分割入金の可能性判定
  - 総合的なスコアリング

### v2.0 (2025-09-10)
- 初版リリース
  - 主観的評価を除外
  - 100点満点のスコアリングシステム導入
  - 3段階の処理フェーズ確立

