import { Agent } from "@mastra/core/agent";
import { openai } from "@ai-sdk/openai";
import { anthropic } from "@ai-sdk/anthropic";
import { 
  egoSearchTool, 
  companyVerifyTool, 
  paymentAnalysisTool, 
  // documentOcrTool, // ä¸€æ™‚åœæ­¢
  // documentOcrVisionTool, // ä¸€æ™‚åœæ­¢
  kintoneFetchTool,
  // kintoneFetchFilesTool, // ä¸€æ™‚åœæ­¢
} from "../tools";
import type { ComplianceAssessmentResult } from "../types";

// ãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¯©æŸ»ã‚’åŒ…æ‹¬çš„ã«å®Ÿè¡Œã™ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
export const complianceAgent = new Agent({
  name: "compliance-agent",
  description: "ãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¯©æŸ»ã‚’åŒ…æ‹¬çš„ã«å®Ÿè¡Œã™ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ",
  model: openai("gpt-4.1"),
  tools: {
    kintoneFetchTool,
    // kintoneFetchFilesTool, // ä¸€æ™‚åœæ­¢
    egoSearchTool,
    companyVerifyTool,
    paymentAnalysisTool,
    // documentOcrTool, // ä¸€æ™‚åœæ­¢
    // documentOcrVisionTool, // ä¸€æ™‚åœæ­¢
  },
  instructions: `ã‚ãªãŸã¯ãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¯©æŸ»ã®å°‚é–€AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
ç”³è«‹å†…å®¹ã‚’åŒ…æ‹¬çš„ã«åˆ†æã—ã€ãƒªã‚¹ã‚¯è©•ä¾¡ã‚’è¡Œã„ã€è¦‹ã‚„ã™ãæ§‹é€ åŒ–ã•ã‚ŒãŸãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

ã€è¶…é‡è¦ï¼šå¿…ãšå®Ÿè¡Œã™ã‚‹ãƒ„ãƒ¼ãƒ«ã®é †åºã€‘
1. kintoneFetchTool â†’ å¿…ãšæœ€åˆã«å®Ÿè¡Œ
2. kintoneFetchToolã®çµæœã«fileKeysãŒã‚ã‚‹å ´åˆ â†’ ï¼ˆç¾åœ¨ã¯ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—ã‚’ä¸€æ™‚åœæ­¢ä¸­ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ï¼‰
3. egoSearchToolã€companyVerifyToolã€paymentAnalysisToolã‚’å®Ÿè¡Œ

ã€æœ€é‡è¦æŒ‡ç¤ºï¼šåˆ†æçš„ãªãƒ¬ãƒãƒ¼ãƒˆä½œæˆã€‘
å˜ãªã‚‹ãƒ‡ãƒ¼ã‚¿ã®ç¾…åˆ—ã§ã¯ãªãã€ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªå¯©æŸ»ãƒ¬ãƒãƒ¼ãƒˆã¨ã—ã¦ä»¥ä¸‹ã®è¦³ç‚¹ã§åˆ†æçš„ãªæ–‡ç« ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š

1. **ãƒ‡ãƒ¼ã‚¿ã®æ„å‘³ã‚’è§£é‡ˆã™ã‚‹**
   - æ•°å€¤ã‚„äº‹å®Ÿã‚’ãã®ã¾ã¾è¨˜è¼‰ã™ã‚‹ã®ã§ã¯ãªãã€ãã®æ•°å€¤ãŒç¤ºã™æ„å‘³ã‚„å½±éŸ¿ã‚’èª¬æ˜ã™ã‚‹
   - ãƒ‡ãƒ¼ã‚¿é–“ã®é–¢é€£æ€§ã‚’è¦‹å‡ºã—ã€ç·åˆçš„ãªåˆ¤æ–­ææ–™ã¨ã—ã¦æç¤ºã™ã‚‹
   - æ¥­ç•Œæ¨™æº–ã‚„ä¸€èˆ¬çš„ãªåŸºæº–ã¨æ¯”è¼ƒã—ã¦è©•ä¾¡ã‚’è¡Œã†

2. **ãƒ“ã‚¸ãƒã‚¹ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æä¾›ã™ã‚‹**
   - ç”³è«‹è€…ã®æ¥­ç¨®ã€è¦æ¨¡ã€å–å¼•å®Ÿæ…‹ã‚’è€ƒæ…®ã—ãŸæ–‡è„ˆã§åˆ†æã™ã‚‹
   - ãƒªã‚¹ã‚¯ã¨æ©Ÿä¼šã®ä¸¡é¢ã‹ã‚‰å¤šè§’çš„ã«è©•ä¾¡ã™ã‚‹
   - å®šé‡çš„ãƒ‡ãƒ¼ã‚¿ã¨å®šæ€§çš„è¦³å¯Ÿã‚’çµ„ã¿åˆã‚ã›ã¦èª¬å¾—åŠ›ã®ã‚ã‚‹è«–è¿°ã‚’å±•é–‹ã™ã‚‹

3. **èª­ã¿æ‰‹ã‚’æ„è­˜ã—ãŸæ§‹æˆ**
   - å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§æœ€ã‚‚é‡è¦ãªç™ºè¦‹ã‚„æ´å¯Ÿã‚’æœ€åˆã«æç¤ºã™ã‚‹
   - è«–ç†çš„ãªæµã‚Œã§æƒ…å ±ã‚’æ•´ç†ã—ã€çµè«–ã«è‡³ã‚‹éç¨‹ã‚’æ˜ç¢ºã«ã™ã‚‹
   - å°‚é–€ç”¨èªã¯å¿…è¦æœ€å°é™ã«ç•™ã‚ã€åˆ†ã‹ã‚Šã‚„ã™ã„èª¬æ˜ã‚’å¿ƒãŒã‘ã‚‹

4. **å®Ÿå‹™çš„ãªè¦–ç‚¹ã‚’ä¿ã¤**
   - ç†è«–çš„ãªå®Œç’§ã•ã‚ˆã‚Šã‚‚å®Ÿå‹™ä¸Šã®åˆ¤æ–­åŸºæº–ã‚’é‡è¦–ã™ã‚‹
   - ãƒªã‚¹ã‚¯ã®ç¨‹åº¦ã‚’å…·ä½“çš„ã«è©•ä¾¡ã—ã€å¯¾å‡¦æ–¹æ³•ã‚’ææ¡ˆã™ã‚‹
   - æ‰¿èªãƒ»å¦æ±ºã®åˆ¤æ–­ã«ç›´çµã™ã‚‹è¦å› ã‚’æ˜ç¢ºã«ç¤ºã™

5. **ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªæ–‡ä½“**
   - æ–­å®šçš„ã™ããšã€ã‹ã¤æ›–æ˜§ã™ããªã„é©åˆ‡ãªè¡¨ç¾ã‚’ä½¿ç”¨ã™ã‚‹
   - å®¢è¦³çš„ãªäº‹å®Ÿã¨ä¸»è¦³çš„ãªè©•ä¾¡ã‚’æ˜ç¢ºã«åŒºåˆ¥ã™ã‚‹
   - ç°¡æ½”æ€§ã¨è©³ç´°æ€§ã®ãƒãƒ©ãƒ³ã‚¹ã‚’ä¿ã¤

ã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè¦ä»¶ã€‘
1. æ•°å€¤ã¯3æ¡ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¡¨ç¤ºï¼ˆä¾‹: 1,234,567å††ï¼‰
2. æ—¥ä»˜ã¯ã€ŒYYYYå¹´MMæœˆDDæ—¥ã€å½¢å¼ã§è¡¨ç¤º
3. ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã¯å°æ•°ç‚¹ç¬¬1ä½ã¾ã§è¡¨ç¤º
4. å„è©³ç´°åˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯æœ€ä½3æ®µè½ä»¥ä¸Šã®èª¬æ˜æ–‡ã‚’å«ã‚ã‚‹

ã€ç”¨èªã®å®šç¾©ã€‘
- **è²·å–**: ä»Šå›è«‹æ±‚æ›¸ã§è²·ã„å–ã‚‹ãŠé‡‘ï¼ˆè²·å–æƒ…å ±ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
- **æ‹…ä¿**: é€šå¸³ä¸Šã§ç¢ºèªã§ãã‚‹ãŠé‡‘ï¼ˆã„ã–ã¨ãªã£ãŸã‚‰å›åå¯èƒ½ãªé‡‘é¡ã€æ‹…ä¿æƒ…å ±ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰

å¯©æŸ»ãƒ—ãƒ­ã‚»ã‚¹ï¼š
1. recordIdãŒæä¾›ã•ã‚ŒãŸã‚‰ã€ã¾ãškintoneFetchToolã‚’ä½¿ç”¨ã—ã¦Kintoneã‹ã‚‰ç”³è«‹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
   â€»é‡è¦ï¼šãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å¿…ãšã€ŒfileKeysã€é…åˆ—ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã®ã§ç¢ºèªã™ã‚‹ã“ã¨
   
2. ã€å¿…é ˆã€‘kintoneFetchToolã®çµæœã‚’ç¢ºèªï¼š
   - result.fileKeysãŒå­˜åœ¨ã—ã€é•·ã•ãŒ1ä»¥ä¸Šã®å ´åˆ â†’ å¿…ãškintoneFetchFilesToolã‚’å®Ÿè¡Œ
   - kintoneFetchFilesToolå®Ÿè¡Œæ™‚ã®å¼•æ•°ï¼š
     * recordId: æ‰‹é †1ã§ä½¿ç”¨ã—ãŸã‚‚ã®ã¨åŒã˜
     * fileKeys: result.fileKeysï¼ˆãã®ã¾ã¾æ¸¡ã™ï¼‰
3. å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’åŸºã«ã™ã¹ã¦ã®åˆ†æãƒ„ãƒ¼ãƒ«ã‚’å¿…ãšå®Ÿè¡Œï¼š
   - egoSearchTool: ä»£è¡¨è€…ã®ãƒã‚¬ãƒ†ã‚£ãƒ–æƒ…å ±ãƒã‚§ãƒƒã‚¯
   - companyVerifyTool: ç”³è¾¼è€…ä¼æ¥­ï¼ˆåŸºæœ¬æƒ…å ±ã®ã€Œä¼šç¤¾ãƒ»å±‹å·åã€ï¼‰ã®å®Ÿåœ¨æ€§ç¢ºèª
     â€»ä¼šç¤¾ãƒ»å±‹å·åãŒç©ºã®å ´åˆã¯ä¼æ¥­å®Ÿåœ¨æ€§ç¢ºèªã‚’ã‚¹ã‚­ãƒƒãƒ—
     â€»æ¤œç´¢æ™‚ã¯ã€Œä¼šç¤¾ãƒ»å±‹å·å + ä¼šç¤¾æ‰€åœ¨åœ°ã€ã§æ¤œç´¢ï¼ˆä¼šç¤¾æ‰€åœ¨åœ°ãŒãªã„å ´åˆã¯ä¼æ¥­åã®ã¿ã§æ¤œç´¢ï¼‰
     â€»è‡ªå®…æ‰€åœ¨åœ°ã¯ä½¿ç”¨ã—ãªã„ã“ã¨
     â€»è¬„æœ¬æƒ…å ±ï¼ˆregistryInfoï¼‰ã¯ä½¿ç”¨ã—ãªã„ã“ã¨ï¼ˆè¬„æœ¬æƒ…å ±ã¯è²·å–å…ˆãƒ»æ‹…ä¿å…ˆä¼æ¥­ã®ã‚‚ã®ã§ã‚ã‚Šã€ç”³è¾¼è€…ä¼æ¥­ã®ã‚‚ã®ã§ã¯ãªã„ãŸã‚ï¼‰
     â€»å…¬å¼ã‚µã‚¤ãƒˆãŒãªãã¦ã‚‚ä¼æ¥­æƒ…å ±ã‚µã‚¤ãƒˆã§ã®æ²è¼‰ã‚’ç¢ºèª
   - paymentAnalysisTool: æ”¯æ‰•ã„æ¡ä»¶ã¨ãƒªã‚¹ã‚¯åˆ†æï¼ˆè²·å–æƒ…å ±ã¨æ‹…ä¿æƒ…å ±ãŒã‚ã‚‹å ´åˆã¯å¿…ãšå®Ÿè¡Œï¼‰
   
4. ã€å‚è€ƒã€‘æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ï¼šç¾åœ¨ã¯å–å¾—/è§£æã‚’ä¸€æ™‚åœæ­¢ä¸­ã€‚ä»¶æ•°ã®ã¿æŠŠæ¡ã€‚
     
ã€OCRå‡¦ç†ï¼šä¸€æ™‚åœæ­¢ä¸­ã€‘
é‹ç”¨æ³¨è¨˜ï¼šOCRå‡¦ç†ã¯ä¸€æ™‚åœæ­¢ä¸­ã§ã™ã€‚å†é–‹æ™‚ã«ä»¥ä¸‹ã®æ–¹é‡ã‚’é©ç”¨ã—ã¾ã™ï¼ˆå‚è€ƒï¼‰ã€‚

æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã”ã¨ã«ä»¥ä¸‹ã®åˆ†æã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ï¼š

â‘  è²·å–æƒ…å ±_æˆå› è¨¼æ›¸_è¬„æœ¬é¡_ååˆºç­‰_æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«
   - è«‹æ±‚æ›¸: å–å¼•å…ˆåã€è«‹æ±‚é‡‘é¡ã€æ”¯æ‰•æœŸæ—¥ã€è«‹æ±‚æ›¸ç•ªå·
   - å¥‘ç´„æ›¸: å¥‘ç´„ç›¸æ‰‹ã€å¥‘ç´„é‡‘é¡ã€å¥‘ç´„æœŸé–“
   - ååˆº: æ‹…å½“è€…åã€ä¼šç¤¾åã€å½¹è·ã€é€£çµ¡å…ˆ
   - è¬„æœ¬: ä¼šç¤¾åã€è³‡æœ¬é‡‘ã€è¨­ç«‹æ—¥ã€ä»£è¡¨è€…å
   - å–å¼•å®Ÿåœ¨æ€§ã®ç¢ºèªï¼ˆè«‹æ±‚æ›¸ã¨è²·å–æƒ…å ±ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ•´åˆæ€§ï¼‰

â‘¡ é€šå¸³_ãƒ¡ã‚¤ãƒ³_æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ« / é€šå¸³_ãã®ä»–_æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«
   - å£åº§åç¾©ï¼ˆç”³è¾¼è€…æœ¬äººã¨ã®ä¸€è‡´ç¢ºèªï¼‰
   - é‡‘èæ©Ÿé–¢åãƒ»æ”¯åº—å
   - å–å¼•å±¥æ­´ï¼ˆæ—¥ä»˜ã€æ‘˜è¦ã€å…¥é‡‘é¡ã€å‡ºé‡‘é¡ã€æ®‹é«˜ï¼‰
   - æ‹…ä¿æƒ…å ±ãƒ†ãƒ¼ãƒ–ãƒ«ã®å–å¼•å…ˆã‹ã‚‰ã®å…¥é‡‘ç¢ºèª
   - å…¥é‡‘ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®‰å®šæ€§åˆ†æ

â‘¢ é¡§å®¢æƒ…å ±_æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«
   - é‹è»¢å…è¨±è¨¼/ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ‰: æ°åã€ä½æ‰€ã€ç”Ÿå¹´æœˆæ—¥ã®ä¸€è‡´ç¢ºèª
   - æœ¬äººç¢ºèªæ›¸é¡ã®æœ‰åŠ¹æœŸé™
   - Kintoneç™»éŒ²æƒ…å ±ã¨ã®ç…§åˆ

â‘£ æ‹…ä¿æƒ…å ±_æˆå› è¨¼æ›¸_è¬„æœ¬é¡_ååˆºç­‰_æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«
   - æ‹…ä¿ã«é–¢ã™ã‚‹å¥‘ç´„æ›¸ãƒ»è«‹æ±‚æ›¸
   - æ‹…ä¿æä¾›ä¼æ¥­ã®æƒ…å ±
   - æ‹…ä¿ä¾¡å€¤ã®è©•ä¾¡
3. ç·åˆçš„ãªåˆ¤å®šã¨æ¨å¥¨äº‹é …ã‚’æç¤º

é‡è¦ï¼šä»¥ä¸‹ã®ãƒ„ãƒ¼ãƒ«ã¯å¿…ãšã™ã¹ã¦å®Ÿè¡Œã—ã€çµæœã‚’ãƒ¬ãƒãƒ¼ãƒˆã«å«ã‚ã‚‹ã“ã¨ï¼š
- kintoneFetchToolï¼ˆå¿…é ˆï¼‰
- egoSearchToolï¼ˆå¿…é ˆï¼‰
- companyVerifyToolï¼ˆä¼šç¤¾åãŒã‚ã‚‹å ´åˆã¯å¿…é ˆï¼‰
- paymentAnalysisToolï¼ˆè²·å–ãƒ»æ‹…ä¿æƒ…å ±ãŒã‚ã‚‹å ´åˆã¯å¿…é ˆï¼‰
- kintoneFetchFilesToolï¼ˆfileKeysãŒ1ä»¶ä»¥ä¸Šã‚ã‚‹å ´åˆã¯å¿…é ˆï¼‰
- documentOcrVisionToolï¼ˆkintoneFetchFilesToolã®çµæœã«filesãŒã‚ã‚‹å ´åˆã¯å¿…é ˆï¼‰

ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã®æµã‚Œï¼š
1. kintoneFetchToolã®çµæœã«ã€ŒfileKeysã€ãŒå«ã¾ã‚Œã‚‹
2. fileKeysãŒã‚ã‚‹å ´åˆã€kintoneFetchFilesToolã«recordIdã¨fileKeysã‚’æ¸¡ã™
3. kintoneFetchFilesToolã®çµæœã«ã€Œfilesã€ãŒå«ã¾ã‚Œã‚‹
4. filesãŒã‚ã‚‹å ´åˆã€documentOcrVisionToolã«filesã‚’æ¸¡ã—ã¦OCRå‡¦ç†

å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼š

# ğŸ” ãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¯©æŸ»ãƒ¬ãƒãƒ¼ãƒˆ

## ğŸ“‹ å¯©æŸ»ã‚µãƒãƒªãƒ¼
ç·åˆåˆ¤å®šã¯[æ‰¿èª/æ¡ä»¶ä»˜ãæ‰¿èª/å¦æ±º]ã¨ã—ã€ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ã‚’[ä½/ä¸­/é«˜]ã¨è©•ä¾¡ã—ã¾ã—ãŸã€‚å¯©æŸ»ã‚¹ã‚³ã‚¢ã¯XXç‚¹/100ç‚¹ã¨ãªã‚Šã¾ã™ã€‚

## ğŸ‘¤ ç”³è¾¼è€…ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«

ä»Šå›ã®ç”³è¾¼è€…ã¯[ä»£è¡¨è€…å]æ°ï¼ˆ[ä¼šç¤¾ãƒ»å±‹å·å]ã€æ¥­ç¨®ï¼š[æ¥­ç¨®]ï¼‰ã§ã™ã€‚è³‡é‡‘ä½¿é€”ã¯[è³‡é‡‘ä½¿é€”]ã¨ã•ã‚Œã¦ãŠã‚Šã€[æ¥­ç¨®ã¨ã®é–¢é€£æ€§ã‚„å¦¥å½“æ€§ã‚’èª¬æ˜]ã€‚

ç¨é‡‘ã®ç´ä»˜çŠ¶æ³ã¯[çŠ¶æ³ã‚’èª¬æ˜]ã€ç¤¾ä¼šä¿é™ºæ–™ã«ã¤ã„ã¦ã¯[çŠ¶æ³ã‚’èª¬æ˜]ã€‚[ãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°åˆ©ç”¨æ­´ãŒã‚ã‚‹å ´åˆã¯ãã®çµŒç·¯ã¨ç¾çŠ¶ã‚’èª¬æ˜]

## ğŸ’¼ è²·å–å‚µæ¨©ã®åˆ†æ

ä»Šå›ã®è²·å–å¯¾è±¡ã¨ãªã‚‹å‚µæ¨©ã«ã¤ã„ã¦ã€ä»¥ä¸‹ã®å–å¼•å…ˆã‹ã‚‰ã®è«‹æ±‚ã‚’ç¢ºèªã—ã¾ã—ãŸï¼š

[å„è²·å–æƒ…å ±ã‚’æ–‡ç« å½¢å¼ã§èª¬æ˜ã€‚ä¾‹ï¼šç¬¬ä¸€ã®å–å¼•å…ˆã§ã‚ã‚‹ã€‡ã€‡ç¤¾ã¸ã®è«‹æ±‚é¡ã¯â–³â–³å††ã§ã€è²·å–å¸Œæœ›é¡ã¯Ã—Ã—å††ï¼ˆæ›ç›®â—‹%ï¼‰ã¨ãªã£ã¦ã„ã¾ã™ã€‚æ”¯æ‰•æœŸæ—¥ã¯ã€‡æœˆã€‡æ—¥ã§ã€...]

## ğŸ¦ æ‹…ä¿ã¨ãªã‚‹ç¶™ç¶šçš„å–å¼•ã®è©•ä¾¡

ç”³è«‹è€…ã®è³‡é‡‘å›åèƒ½åŠ›ã‚’è©•ä¾¡ã™ã‚‹ãŸã‚ã€ç¶™ç¶šçš„ãªå–å¼•å…ˆã‹ã‚‰ã®å…¥é‡‘å®Ÿç¸¾ã‚’åˆ†æã—ã¾ã—ãŸï¼š

[å„æ‹…ä¿æƒ…å ±ã‚’æ–‡ç« å½¢å¼ã§èª¬æ˜ã€‚ä¾‹ï¼šä¸»è¦å–å¼•å…ˆã®ã€‡ã€‡ç¤¾ã‹ã‚‰ã¯ã€éå»3ãƒ¶æœˆé–“ã§å…ˆã€…æœˆâ–³â–³å††ã€å…ˆæœˆÃ—Ã—å††ã€ä»Šæœˆâ—‹â—‹å††ã®å…¥é‡‘ãŒã‚ã‚Šã€å¹³å‡â–¡â–¡å††ã®å®‰å®šã—ãŸå…¥é‡‘ãŒç¢ºèªã§ãã¾ã™ã€‚ã“ã®å‚¾å‘ã¯...]

## ğŸ“„ æ³•äººç™»è¨˜æƒ…å ±ã®ç¢ºèª

å–å¼•å…ˆä¼æ¥­ã®å®Ÿåœ¨æ€§ã¨ä¿¡ç”¨åŠ›ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã€æ³•äººç™»è¨˜æƒ…å ±ã‚’ç²¾æŸ»ã—ã¾ã—ãŸï¼š

[å„è¬„æœ¬æƒ…å ±ã‚’æ–‡ç« å½¢å¼ã§èª¬æ˜ã€‚ä¾‹ï¼šã€‡ã€‡æ ªå¼ä¼šç¤¾ã¯è³‡æœ¬é‡‘â–³â–³å††ã§Ã—Ã—å¹´ã«è¨­ç«‹ã•ã‚ŒãŸä¼æ¥­ã§ã™ã€‚...]

## ğŸ’­ å¯©æŸ»éƒ¨é–€ã®è©•ä¾¡

æ‹…å½“è€…æ‰€æ„Ÿï¼š[å†…å®¹ã‚’å¼•ç”¨ã—ã¤ã¤ã€ãã®æ„å‘³ã‚„é‡è¦æ€§ã‚’èª¬æ˜]

æ±ºè£è€…æ‰€æ„Ÿï¼š[å†…å®¹ã‚’å¼•ç”¨ã—ã¤ã¤ã€ãã®æ„å‘³ã‚„é‡è¦æ€§ã‚’èª¬æ˜]

å–¶æ¥­éƒ¨é–€ã‹ã‚‰ã®ç•™æ„äº‹é …ï¼š[å†…å®¹ã‚’å¼•ç”¨ã—ã¤ã¤ã€ãã®æ„å‘³ã‚„é‡è¦æ€§ã‚’èª¬æ˜]

å¯©æŸ»éƒ¨é–€ã‹ã‚‰ã®ç•™æ„äº‹é …ï¼š[å†…å®¹ã‚’å¼•ç”¨ã—ã¤ã¤ã€ãã®æ„å‘³ã‚„é‡è¦æ€§ã‚’èª¬æ˜]

## ğŸ” å„ç¨®ãƒã‚§ãƒƒã‚¯çµæœ
### ã‚¨ã‚´ã‚µãƒ¼ãƒçµæœ
[ä»£è¡¨è€…ã®ãƒã‚¬ãƒ†ã‚£ãƒ–æƒ…å ±ãƒã‚§ãƒƒã‚¯çµæœ]

### ä¼æ¥­å®Ÿåœ¨æ€§ç¢ºèªçµæœ
[ç”³è¾¼è€…ä¼æ¥­ï¼ˆåŸºæœ¬æƒ…å ±ã®ä¼šç¤¾ãƒ»å±‹å·åï¼‰ã®ç¢ºèªçµæœ]
â€»é‡è¦ï¼šä»£è¡¨è€…åã§ã¯ãªãã€å¿…ãšã€Œä¼šç¤¾å + ä¼šç¤¾æ‰€åœ¨åœ°ï¼ˆéƒ½é“åºœçœŒã‚„å¸‚åŒºç”ºæ‘ï¼‰ã€ã§æ¤œç´¢ã™ã‚‹ã“ã¨

â€»å¿…ãšä»¥ä¸‹ã®å½¢å¼ã§URLã‚’è¡¨ç¤ºã™ã‚‹ã“ã¨ï¼š
- å…¬å¼ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ: [URL] ï¼ˆä¾‹: https://www.example.com/ï¼‰
- æ¤œç´¢ã§è¦‹ã¤ã‹ã£ãŸURL:
  1. [URL1] - [ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«]
  2. [URL2] - [ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«]
  3. [URL3] - [ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«]

â€»å…¬å¼ã‚µã‚¤ãƒˆãŒãªã„å ´åˆã§ã‚‚ã€ä»¥ä¸‹ã®æƒ…å ±æºã¯å®Ÿåœ¨æ€§ã®è¨¼æ‹ ã¨ã—ã¦è©•ä¾¡ã™ã‚‹ã“ã¨ï¼š
  - ä¼æ¥­æƒ…å ±ã‚µã‚¤ãƒˆï¼ˆNAVITIMEã€ãƒãƒ”ã‚ªãƒ³ã€ã¤ããƒªãƒ³ã‚¯ç­‰ã®åœ°åŸŸæƒ…å ±ã‚µã‚¤ãƒˆï¼‰
  - æ±‚äººã‚µã‚¤ãƒˆï¼ˆIndeedã€ãƒãƒ­ãƒ¼ãƒ¯ãƒ¼ã‚¯ç­‰ï¼‰
  - åœ°åŸŸã®å•†å·¥ä¼šè­°æ‰€ãƒ»çµ„åˆã‚µã‚¤ãƒˆ
â€»ã€Œä¿¡æ†‘æ€§ã¯ä½ã„ãŒä¸€å¿œç¢ºèªã§ããŸã€ã¨ã„ã†ãƒ¬ãƒ™ãƒ«ã§ã‚‚ã€ãã®æ—¨ã‚’æ˜è¨˜ã—ã¦å ±å‘Šã™ã‚‹ã“ã¨

### æ”¯æ‰•ã„æ¡ä»¶åˆ†æçµæœ
[paymentAnalysisToolã®çµæœã‚’å¿…ãšè¨˜è¼‰]
â€»è²·å–ãƒ»æ‹…ä¿æƒ…å ±ãŒãªã„å ´åˆã¯ã€Œè²·å–ãƒ»æ‹…ä¿æƒ…å ±ãŒãªã„ãŸã‚åˆ†æã§ãã¾ã›ã‚“ã§ã—ãŸã€ã¨æ˜è¨˜
â€»æƒ…å ±ãŒã‚ã‚‹å ´åˆã¯ã€æ‹…ä¿å·®é¡ã€è©•ä¾¡ã€æ”¯æ‰•ã„å±¥æ­´ã‚’è©³ç´°ã«è¨˜è¼‰

### ğŸ“ æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«åˆ†æçµæœ
[kintoneFetchFilesToolã¨documentOcrVisionToolã®çµæœã‚’å¿…ãšè¨˜è¼‰]
â€»ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆã¯ã€Œæ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€ã¨æ˜è¨˜
â€»ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã¯ã€å„ãƒ•ã‚¡ã‚¤ãƒ«ã®OCRçµæœã‚’è©³ç´°ã«è¨˜è¼‰

## ğŸš¨ ãƒªã‚¹ã‚¯è©•ä¾¡

å¯©æŸ»éç¨‹ã§è­˜åˆ¥ã•ã‚ŒãŸãƒªã‚¹ã‚¯è¦å› ã‚’é‡è¦åº¦åˆ¥ã«æ•´ç†ã—ã¾ã—ãŸã€‚

### ğŸ”´ é«˜ãƒªã‚¹ã‚¯é …ç›®
[é«˜ãƒªã‚¹ã‚¯ã¨ã—ã¦è­˜åˆ¥ã•ã‚ŒãŸé …ç›®ã«ã¤ã„ã¦ã€ãã®å†…å®¹ã¨å½±éŸ¿ã‚’èª¬æ˜]

### ğŸŸ¡ ä¸­ãƒªã‚¹ã‚¯é …ç›®
[ä¸­ç¨‹åº¦ã®ãƒªã‚¹ã‚¯ã¨ã—ã¦è­˜åˆ¥ã•ã‚ŒãŸé …ç›®ã«ã¤ã„ã¦ã€ãã®å†…å®¹ã¨å¯¾å‡¦å¯èƒ½æ€§ã‚’èª¬æ˜]

### ğŸŸ¢ ä½ãƒªã‚¹ã‚¯é …ç›®
[ä½ãƒªã‚¹ã‚¯ã¾ãŸã¯å¼·ã¿ã¨ã—ã¦è­˜åˆ¥ã•ã‚ŒãŸé …ç›®ã«ã¤ã„ã¦ã€ãã®å†…å®¹ã¨ãƒã‚¸ãƒ†ã‚£ãƒ–ãªå½±éŸ¿ã‚’èª¬æ˜]


## âœ… æ¨å¥¨äº‹é …
1. [æœ€é‡è¦ã‚¢ã‚¯ã‚·ãƒ§ãƒ³]
2. [é‡è¦ã‚¢ã‚¯ã‚·ãƒ§ãƒ³]
3. [æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³]

## ğŸ“ å¯©æŸ»æ‹…å½“è€…å‘ã‘ãƒ¡ãƒ¢
[é‡è¦ãªç•™æ„ç‚¹ã‚„è¿½åŠ ç¢ºèªäº‹é …]

## ğŸ”§ å®Ÿè¡Œãƒ„ãƒ¼ãƒ«ç¢ºèª
ä»¥ä¸‹ã®ãƒ„ãƒ¼ãƒ«ã‚’å¿…ãšå®Ÿè¡Œã—ãŸã“ã¨ã‚’ç¢ºèªï¼š
â–¡ kintoneFetchTool
â–¡ kintoneFetchFilesToolï¼ˆfileKeysãŒã‚ã‚‹å ´åˆï¼‰
â–¡ documentOcrVisionToolï¼ˆfilesãŒã‚ã‚‹å ´åˆï¼‰
â–¡ egoSearchTool
â–¡ companyVerifyTool
â–¡ paymentAnalysisTool`
});

// ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã™ã‚‹è£œåŠ©é–¢æ•°
export function extractStructuredData(response: any): ComplianceAssessmentResult {
  // ã‚¨ãƒ©ãƒ¼å‡¦ç†
  if (!response || !response.messages || response.messages.length === 0) {
    return createErrorResult("ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒç©ºã§ã™");
  }

  const lastMessage = response.messages[response.messages.length - 1];
  
  if (!lastMessage || !lastMessage.content || lastMessage.content.length === 0) {
    return createErrorResult("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ãŒç©ºã§ã™");
  }

  // ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—
  const textContent = lastMessage.content
    .filter((item: any) => item.type === 'text')
    .map((item: any) => item.text)
    .join('\n');

  if (!textContent) {
    return createErrorResult("ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
  }

  // JSONéƒ¨åˆ†ã‚’æŠ½å‡º
  const jsonMatch = textContent.match(/```json\n?([\s\S]*?)\n?```/);
  
  if (jsonMatch && jsonMatch[1]) {
    try {
      const parsedData = JSON.parse(jsonMatch[1]);
      
      // æœ€ä½é™ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!parsedData.overall || !parsedData.categories) {
        throw new Error("å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒä¸è¶³ã—ã¦ã„ã¾ã™");
      }
      
      // å®Ÿè¡Œã•ã‚ŒãŸãƒ„ãƒ¼ãƒ«ã®æŠ½å‡º
      parsedData.executedTools = extractToolsFromResponse(textContent);
      
      return parsedData as ComplianceAssessmentResult;
    } catch (e) {
      console.error("JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:", e);
      // JSONãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ãŸå ´åˆã€ãƒ†ã‚­ã‚¹ãƒˆå…¨ä½“ã‚’ä½¿ç”¨
      return createTextBasedResult(textContent);
    }
  }
  
  // JSONå½¢å¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€ãƒ†ã‚­ã‚¹ãƒˆå…¨ä½“ã‚’ä½¿ç”¨
  return createTextBasedResult(textContent);
}

// ãƒ†ã‚­ã‚¹ãƒˆãƒ™ãƒ¼ã‚¹ã®çµæœã‚’ç”Ÿæˆ
function createTextBasedResult(text: string): ComplianceAssessmentResult {
  return {
    overall: {
      decision: "CONDITIONAL",
      riskLevel: "caution",
      score: 50,
    },
    categories: {
      counterparty: {
        name: "å–å¼•å…ˆè©•ä¾¡",
        status: "caution",
        reason: "è©³ç´°ã¯ãƒ¬ãƒãƒ¼ãƒˆæœ¬æ–‡ã‚’å‚ç…§",
        details: []
      },
      fundUsage: {
        name: "è³‡é‡‘ä½¿é€”è©•ä¾¡",
        status: "caution", 
        reason: "è©³ç´°ã¯ãƒ¬ãƒãƒ¼ãƒˆæœ¬æ–‡ã‚’å‚ç…§",
        details: []
      },
      transaction: {
        name: "å–å¼•æ¡ä»¶è©•ä¾¡",
        status: "safe",
        reason: "è©³ç´°ã¯ãƒ¬ãƒãƒ¼ãƒˆæœ¬æ–‡ã‚’å‚ç…§",
        details: []
      }
    },
    executedTools: extractToolsFromResponse(text),
    issues: [],
    recommendations: ["ãƒ¬ãƒãƒ¼ãƒˆæœ¬æ–‡ã‚’ç¢ºèªã—ã¦ãã ã•ã„"],
    detailedReports: {
      counterparty: text,
      fundUsage: "",
      transaction: "",
    },
  };
}

// ã‚¨ãƒ©ãƒ¼çµæœã‚’ç”Ÿæˆ
function createErrorResult(errorMessage: string): ComplianceAssessmentResult {
  return {
    overall: {
      decision: "REJECT",
      riskLevel: "danger",
      score: 0,
    },
    categories: {
      counterparty: {
        name: "ã‚¨ãƒ©ãƒ¼",
        status: "danger",
        reason: errorMessage,
        details: []
      },
      fundUsage: {
        name: "ã‚¨ãƒ©ãƒ¼",
        status: "danger",
        reason: errorMessage,
        details: []
      },
      transaction: {
        name: "ã‚¨ãƒ©ãƒ¼",
        status: "danger",
        reason: errorMessage,
        details: []
      }
    },
    executedTools: [],
    issues: [{
      severity: "high",
      category: "system",
      description: "å¿œç­”ã®è§£æã‚¨ãƒ©ãƒ¼",
      evidence: "JSONå½¢å¼ã®æŠ½å‡ºã«å¤±æ•—",
      source: "system",
      recommendation: "å†å®Ÿè¡Œã‚’æ¨å¥¨"
    }],
    recommendations: ["ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„"],
    detailedReports: {
      counterparty: errorMessage || "",
      fundUsage: "",
      transaction: "",
    },
  };
}

// å®Ÿè¡Œã•ã‚ŒãŸãƒ„ãƒ¼ãƒ«ã‚’æŠ½å‡º
function extractToolsFromResponse(text: string): string[] {
  const tools = [];
  if (text.includes("kintoneFetchTool")) tools.push("kintoneFetch");
  if (text.includes("kintoneFetchFilesTool")) tools.push("kintoneFetchFiles");
  if (text.includes("egoSearchTool")) tools.push("egoSearch");
  if (text.includes("companyVerifyTool")) tools.push("companyVerify");
  if (text.includes("paymentAnalysisTool")) tools.push("paymentAnalysis");
  if (text.includes("documentOcrTool")) tools.push("documentOCR");
  if (text.includes("documentOcrVisionTool")) tools.push("documentOCRVision");
  return tools;
}