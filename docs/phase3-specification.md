# Phase 3: 本人確認・企業実在性確認フェーズ 仕様書

## 概要

Phase 3では、Kintoneに添付された本人確認書類のOCR処理と照合、申込者・代表者のエゴサーチ、そして申込企業・買取企業・担保企業の実在性確認を行います。全ての企業検証は1回のAI呼び出しで効率的に処理します。

---

## 処理フロー

### ステップ1: 本人確認書類のOCR処理と照合

**入力:**
- recordId (Kintone レコードID)
- 本人確認フィールド: `顧客情報＿添付ファイル`

**処理内容:**
1. Google Vision APIでOCR実行
2. GPT-4oで書類種別判定と人物情報抽出
3. Kintoneの申込者情報と照合

**対応する書類種別:**
- 履歴事項全部証明書（法人）
- 運転免許証（個人）
- その他本人確認書類

**抽出される情報:**

**履歴事項全部証明書の場合:**
```json
{
  "documentType": "履歴事項全部証明書",
  "persons": [
    {
      "name": "福田昌訓",
      "birthDate": "昭和50年3月15日",
      "address": "大阪府○○市...",
      "nameMatch": true,
      "birthDateMatch": true
    }
  ],
  "companyInfo": {
    "companyName": "昌工業",
    "companyNameMatch": true,
    "capital": "500万円",
    "established": "昭和38年",
    "representative": "福田昌訓",
    "location": "大阪府○○市..."
  }
}
```

**照合ロジック:**
- Kintoneの`顧客情報＿氏名`と書類の氏名を照合
- Kintoneの`生年月日`と書類の生年月日を照合
- Kintoneの`屋号`または`会社名`と書類の会社名を照合

**出力:**
```json
{
  "本人確認": {
    "書類タイプ": "履歴事項全部証明書",
    "照合結果": "氏名・生年月日が一致しました",
    "検出人数": 1,
    "一致人数": 1,
    "一致人物": {
      "氏名": "福田昌訓",
      "生年月日": "昭和50年3月15日",
      "住所": "大阪府○○市..."
    },
    "会社情報": {
      "会社名": "昌工業",
      "会社名照合": "✓ 一致",
      "資本金": "500万円",
      "設立年月日": "昭和38年",
      "代表者名": "福田昌訓",
      "本店所在地": "大阪府○○市..."
    }
  }
}
```

**重要:**
- 本人確認書類が添付されていない場合はスキップ
- 書類タイプ: "なし"、照合結果: "本人確認書類が添付されていません"

---

### ステップ2: 申込者のエゴサーチ

**対象:**
- Kintoneの`顧客情報＿氏名`（本人確認結果から取得、なければKintoneから直接取得）

**処理内容:**
1. 詐欺情報サイトでの検索（eradicationofblackmoney）
2. Web検索（Google Custom Search API）
   - 4つのクエリ: "氏名 詐欺", "氏名 逮捕", "氏名 容疑", "氏名 被害"
   - 各クエリで3件の検索結果を取得
3. **全検索結果を1回のGPT-4o呼び出しで関連性を判定**（最適化済み）

**AI判定プロセス:**
- 従来: 検索結果1件ごとにAI判定（12回の呼び出し）
- 最適化後: 3件の検索結果をまとめて1クエリで判定（4回の呼び出し）
- 判定基準: 本人が詐欺・被害・逮捕・容疑に関わっているか

**出力:**
```json
{
  "申込者エゴサーチ": {
    "ネガティブ情報": false,
    "詐欺情報サイト": 0,
    "Web検索": 0,
    "詳細": "ネガティブ情報は見つかりませんでした。"
  }
}
```

**ネガティブ情報がある場合:**
```json
{
  "申込者エゴサーチ": {
    "ネガティブ情報": true,
    "詐欺情報サイト": 1,
    "Web検索": 2,
    "詳細": "詐欺情報サイトに1件の情報が見つかりました。 Web検索で「氏名 詐欺」「氏名 逮捕」に関する情報が見つかりました（AI判定済み）。"
  }
}
```

---

### ステップ3: 企業実在性確認（一括検証）

**対象企業:**
1. **申込企業**: Kintoneの`屋号`または`会社名`
2. **買取企業**: Phase 1の結果から取得（`phase1Results.purchaseVerification.purchaseInfo.debtorCompanies`）
3. **担保企業**: Kintoneの`担保情報`テーブルから取得

**処理内容:**
1. 全企業の情報を収集（企業名、種別、所在地）
2. 各企業について検索クエリを構築
   - 申込企業（locationあり）: 3クエリ（企業名+所在地、企業名+所在地+建設業、企業名+所在地+建設）
   - 買取・担保企業（locationなし）: 2クエリ（企業名、企業名+建設業）
3. Google Custom Search APIで検索実行（各クエリで3件取得）
4. **全企業の全検索結果を1回のGPT-4o呼び出しで判定**（最適化済み）

**AI判定プロセス:**
- 従来: 企業ごと、検索結果ごとにAI判定（申込1社+担保6社=7社 × 平均2.5クエリ × 3件 = 約52回）
- 最適化後: 全企業の全検索結果を1回で判定（**1回の呼び出し**）
- 判定基準:
  - 企業名の一致度（0-100点）
  - 所在地の一致（指定されている場合）
  - 公式サイトの検出
  - 信頼度計算（70点以上でverified = true）

**出力:**
```json
{
  "企業実在性": {
    "申込企業": {
      "企業名": "昌工業",
      "公式サイト": "https://www.masakogyou.com/company",
      "信頼度": 90
    },
    "買取企業": {
      "総数": 0,
      "確認済み": 0,
      "未確認": 0,
      "企業リスト": []
    },
    "担保企業": {
      "総数": 6,
      "確認済み": 6,
      "未確認": 0,
      "企業リスト": [
        {
          "企業名": "株式会社めばえ建設",
          "公式サイト": "https://mebae-k.net/",
          "信頼度": 90
        },
        {
          "企業名": "株式会社TWINZ HOME",
          "公式サイト": "なし",
          "信頼度": 60
        },
        {
          "企業名": "株式会社一条工務店",
          "公式サイト": "https://www.ichijo.co.jp/",
          "信頼度": 100
        }
      ]
    }
  }
}
```

**信頼度の解釈:**
- **100**: 確実に実在（大手企業など）
- **90**: 高確率で実在（公式サイトあり）
- **60**: 実在の可能性あり（公式サイトなし、検索結果のみ）
- **0**: 実在確認できず

---

### ステップ4: 代表者リスク検索

**対象:**
- Phase 1の担保検証結果から代表者情報を取得（謄本からのみ）
- 注意: 担保謄本ファイルがない場合、代表者情報は取得できない

**処理内容:**
1. 担保企業の代表者名を取得
2. 各代表者についてエゴサーチ実行（申込者と同じプロセス）
3. ネガティブ情報の有無を判定

**出力（リスクがない場合）:**
```json
{
  "代表者リスク": {
    "検索対象": 0,
    "リスク検出": 0
  }
}
```

**出力（リスクがある場合）:**
```json
{
  "代表者リスク": {
    "検索対象": 3,
    "リスク検出": 1,
    "リスク詳細": [
      {
        "氏名": "山田太郎",
        "会社": "株式会社○○建設",
        "企業種別": "担保企業",
        "ネガティブ情報": true,
        "詐欺情報サイト": 1,
        "Web検索": 2
      }
    ]
  }
}
```

---

## Phase 3の最終出力構造

```json
{
  "recordId": "10240",
  "phase3Results": {
    "本人確認": {
      "書類タイプ": "履歴事項全部証明書",
      "照合結果": "氏名・生年月日が一致しました",
      "検出人数": 1,
      "一致人数": 1,
      "一致人物": {
        "氏名": "福田昌訓",
        "生年月日": "昭和50年3月15日",
        "住所": "大阪府○○市..."
      },
      "会社情報": {
        "会社名": "昌工業",
        "会社名照合": "✓ 一致",
        "資本金": "500万円",
        "設立年月日": "昭和38年",
        "代表者名": "福田昌訓",
        "本店所在地": "大阪府○○市..."
      }
    },
    "申込者エゴサーチ": {
      "ネガティブ情報": false,
      "詐欺情報サイト": 0,
      "Web検索": 0,
      "詳細": "ネガティブ情報は見つかりませんでした。"
    },
    "企業実在性": {
      "申込企業": {
        "企業名": "昌工業",
        "公式サイト": "https://www.masakogyou.com/company",
        "信頼度": 90
      },
      "買取企業": {
        "総数": 0,
        "確認済み": 0,
        "未確認": 0,
        "企業リスト": []
      },
      "担保企業": {
        "総数": 6,
        "確認済み": 6,
        "未確認": 0,
        "企業リスト": [
          {
            "企業名": "株式会社めばえ建設",
            "公式サイト": "https://mebae-k.net/",
            "信頼度": 90
          },
          {
            "企業名": "株式会社TWINZ HOME",
            "公式サイト": "なし",
            "信頼度": 60
          }
        ]
      }
    },
    "代表者リスク": {
      "検索対象": 0,
      "リスク検出": 0
    },
    "処理時間": "51.94秒"
  }
}
```

---

## Phase 4（レポートフェーズ）への引き継ぎ事項

### Phase 3で検証済みの項目

✅ **本人確認**
- `本人確認.照合結果`に結果あり
- 書類がない場合は「本人確認書類が添付されていません」
- レポートでは結果を参照し、リスク評価に活用

✅ **申込者のネガティブ情報**
- `申込者エゴサーチ.ネガティブ情報`（boolean）に結果あり
- 詐欺情報サイト件数、Web検索件数、詳細を参照
- ネガティブ情報がある場合は要注意フラグ

✅ **企業実在性**
- 申込企業、買取企業、担保企業の実在性を確認済み
- 信頼度（0-100）で実在性を数値化
- 公式サイトURLを記録（存在する場合）

✅ **代表者リスク**
- 担保企業の代表者についてエゴサーチ実施
- リスクがある場合は詳細情報を記録

### Phase 3で実施していない項目（レポートで判断が必要）

#### 1. 本人確認書類と申込情報の整合性評価
- **検証済みデータ**: 氏名・生年月日の一致/不一致
- **レポートでの判断**:
  - 会社情報（資本金、設立年月日など）とPhase 1の登記情報との整合性
  - 住所情報の妥当性評価
  - 書類がない場合のリスク評価

#### 2. エゴサーチ結果の総合評価
- **検証済みデータ**: 申込者と代表者のネガティブ情報の有無
- **レポートでの判断**:
  - ネガティブ情報の深刻度評価
  - 詐欺情報サイトとWeb検索結果の総合判断
  - 複数の代表者にリスクがある場合の評価

#### 3. 企業実在性の総合評価
- **検証済みデータ**: 各企業の信頼度（0-100）
- **レポートでの判断**:
  - 信頼度が低い企業（60未満）のリスク評価
  - 公式サイトがない企業の取り扱い
  - Phase 1の登記情報・請求書情報との照合
  - 担保企業の実在性と担保価値の関連性

#### 4. 買取企業の実在性
- **検証済みデータ**: `買取企業.企業リスト`
- **注意**: Phase 1の結果がない場合、買取企業情報は取得できない
- **レポートでの判断**:
  - 買取企業が実在しない場合の債権回収リスク
  - Phase 1の請求書情報との整合性

#### 5. 代表者情報の取得可否
- **検証済みデータ**: `代表者リスク.検索対象`が0の場合
- **レポートでの判断**:
  - Phase 1で担保謄本がアップロードされていない可能性
  - 代表者情報なしでの審査リスク評価

---

## 技術仕様

### 使用AI
- **OCR**: Google Vision API
- **本人確認検証**: OpenAI GPT-4o
- **エゴサーチ判定**: OpenAI GPT-4o（Web検索結果の関連性判定）
- **企業実在性確認**: OpenAI GPT-4o（一括判定）

### API呼び出し最適化
**エゴサーチ:**
- 検索API: 4クエリ × 1名 = 4回
- AI判定: 4回（各クエリの3件をまとめて判定）

**企業実在性確認:**
- 検索API: 全企業分（申込3クエリ + 担保6社×2クエリ = 15回）
- AI判定: **1回**（全企業の全検索結果を一括判定）

### コスト構造
- Google Vision API: ページ単価 $0.0015
- Google Custom Search API: クエリ単価 $0.005
- AI判定（GPT-4o）: 入力 $0.0000025/token, 出力 $0.00001/token

---

## 設計思想

### なぜ企業実在性確認を一括処理するのか？

**従来の問題:**
- 企業ごと、検索結果ごとにAI判定 → 大量のAPI呼び出し
- 7社 × 平均2.5クエリ × 3件 = 約52回のAI呼び出し
- コスト高、処理時間長

**一括処理の利点:**
- 全企業の全検索結果を1回のAI呼び出しで判定
- コスト削減: 約98%（52回 → 1回）
- 処理時間短縮: 並列処理不要
- AI判定の一貫性向上: 同一コンテキストで判定

### 信頼度のみを出力する理由

**Phase 3の役割:**
- 企業の実在性を**数値化**して客観的に評価
- 検索結果の詳細（スニペット、リスク要因など）は不要
- Phase 4のレポートAIは信頼度だけで判断可能

**出力する情報:**
- 企業名: 識別用
- 公式サイトURL: 実在確認の根拠
- 信頼度（0-100）: AI判定結果

**出力しない情報:**
- 検索結果の詳細
- スニペット
- リスク要因の詳細
→ これらは判断のための中間データであり、最終レポートには不要

---

## 更新履歴

- 2025-10-04: 初版作成
- Phase 3の処理内容とレポートフェーズへの引き継ぎ事項を明記
- AI呼び出し最適化の実装内容を記載
