# Phase 1: 買取・担保情報処理フェーズ 仕様書

## 概要

Phase 1では、Kintoneに添付された書類（買取請求書・担保謄本）をOCR処理し、文書分類とデータ抽出を行います。
買取請求書についてはKintoneデータとの照合を行いますが、担保情報は事実抽出のみで照合は行いません。

---

## 処理フロー

### ステップ1: OCR処理と文書分類

**入力:**
- recordId (Kintone レコードID)
- 買取情報フィールド: `成因証書＿添付ファイル`
- 担保情報フィールド: `担保情報＿添付ファイル`

**処理内容:**
1. Google Vision APIでOCR実行
2. GPT-4oで文書分類と事実抽出

**文書分類の種類:**
- 請求書
- 登記情報（法人登記簿謄本）
- 債権譲渡概要（現在/閉鎖）
- 名刺
- 契約書
- その他（AIが柔軟に判定）

**抽出される事実情報（extractedFacts）:**
文書の種類によって異なるが、以下のような情報を柔軟に抽出：

**請求書の場合:**
```json
{
  "請求元": "株式会社〇〇",
  "請求先": "株式会社△△",
  "請求額": 3090866,
  "請求日": "R7 9月30日",
  "振込先銀行": "りそな銀行 柏原支店",
  "登録番号": "T5810975567926"
}
```

**登記情報の場合:**
```json
{
  "会社名": "株式会社中央建設",
  "所在地": "埼玉県富士見市諏訪一丁目2番37号",
  "資本金": 3000000,
  "設立年月日": "平成23年5月10日",
  "代表者名": "谷島生葉",
  "役員": "谷島生葉, 谷島正則"
}
```

**債権譲渡概要の場合:**
```json
{
  "会社名": "株式会社中央建設",
  "会社法人等番号": "0300-01-030597",
  "状態": "閉鎖" または "現在",
  "記録状態": "閉鎖" または "現に効力を有する登記事項はない"
}
```

**出力:**
```json
{
  "purchaseDocuments": [
    {
      "fileName": "買取.pdf",
      "documentType": "請求書",
      "extractedFacts": { ... }
    },
    {
      "fileName": "登記簿.pdf",
      "documentType": "登記情報",
      "extractedFacts": { ... }
    }
  ],
  "collateralDocuments": [
    {
      "fileName": "担保.pdf",
      "documentType": "請求書",
      "extractedFacts": { ... }
    }
  ]
}
```

---

### ステップ2: 買取請求書の検証（Kintone照合）

**対象:**
- 買取情報フィールドの**請求書のみ**
- 登記情報、名刺、その他の文書は検証対象外

**照合内容:**
1. Kintoneから買取情報テーブルを取得
2. OCRで抽出した請求書の「請求先」と「請求額」を照合
3. Kintoneの「第三債務者」と「総債権額」と比較

**照合ロジック:**
- 申込者企業（請求元）は第三債務者として抽出しない
- 請求先企業名と金額がKintoneデータと一致するかチェック
- AIが「yes」「partial」「no」で判定

**判定基準:**
- `一致`: OCRデータとKintoneデータが完全一致
- `部分一致`: 一部の企業または金額が一致
- `不一致`: データが一致しない

**出力:**
```json
{
  "purchaseVerification": {
    "kintoneMatch": "一致"
  }
}
```

**重要:**
- 買取請求書以外の文書（登記情報、名刺など）はこのステップで使用しない
- それらの情報はレポートフェーズで活用する想定

---

### ステップ3: 担保情報の抽出（照合なし）

**対象:**
- 担保情報フィールドの**全ての文書**
- 登記簿謄本、請求書、契約書など種類を問わず全て処理

**処理内容:**
1. 各ファイルの文書種別を確認
2. 「何の資料で、何が書いてあったか」を記録
3. **照合は行わず、事実のみを抽出**

**抽出内容:**
- 担保企業名
- 法人番号
- 資本金
- 設立年月日
- 代表者名
- 本店所在地
- 事業内容

**出力:**
```json
{
  "collateralExtraction": {
    "findings": [
      "担保.pdf: 請求書 - 昌 工業から株式会社 TWINS HOMEへの請求書。請求額は1,780,000円で、品名はパークフロント大和田基礎工事。振込先はりそな銀行 柏原支店。"
    ]
  }
}
```

**重要な設計判断:**
- Phase 1では担保情報の照合を行わない
- 理由: 担保企業の照合にはKintoneの全担保データが必要（Phase 1では1件のみ取得）
- 担保企業とKintoneデータの照合はPhase 4のレポート作成時に実施

---

## Phase 1の最終出力構造

```json
{
  "recordId": "10240",
  "phase1Results": {
    "purchaseDocuments": [
      {
        "fileName": "買取.pdf",
        "documentType": "請求書",
        "extractedFacts": {
          "請求元": "昌 工業",
          "請求先": "株式会社 めばえ建築",
          "請求額": 3090866
        }
      },
      {
        "fileName": "登記簿.pdf",
        "documentType": "登記情報",
        "extractedFacts": {
          "会社名": "株式会社 めばえ建築",
          "資本金": 5000000,
          "設立年月日": "2015年4月1日"
        }
      }
    ],
    "collateralDocuments": [
      {
        "fileName": "担保.pdf",
        "documentType": "請求書",
        "extractedFacts": {
          "請求元": "昌 工業",
          "請求先": "株式会社 TWINS HOME",
          "請求額": 1780000
        }
      }
    ],
    "purchaseVerification": {
      "kintoneMatch": "一致"
    },
    "collateralExtraction": {
      "findings": [
        "担保.pdf: 請求書 - 昌 工業から株式会社 TWINS HOMEへの請求書。請求額は1,780,000円"
      ]
    }
  },
  "summary": {
    "processingTime": 13.523,
    "totalCost": 0.048862
  }
}
```

---

## Phase 4（レポートフェーズ）への引き継ぎ事項

### Phase 1で照合済みの項目
✅ **買取請求書とKintone買取情報の照合**
- `purchaseVerification.kintoneMatch`に結果あり
- レポートでは結果を参照するのみ

### Phase 1で照合していない項目（レポートで判断が必要）

#### 1. 買取情報フィールドの登記情報
- **抽出済みデータ:** `purchaseDocuments`内に`documentType: "登記情報"`として存在
- **extractedFactsの内容:** 会社名、資本金、設立年月日、代表者名など
- **レポートでの判断:**
  - この登記情報が第三債務者のものか申込者のものかを判定
  - 請求書の請求先企業と登記情報の会社名を照合
  - 資本金、代表者などの情報を審査材料として評価

#### 2. 担保企業情報とKintoneデータの照合
- **抽出済みデータ:** `collateralExtraction.findings`に文字列として記録
- **Kintone担保データ:** Phase 4で全件取得が必要
- **レポートでの判断:**
  - 担保書類から抽出された企業名とKintone担保情報を照合
  - 資本金、設立年月日などの整合性チェック
  - 担保価値の評価

#### 3. 債権譲渡登記の状態確認
- **抽出済みデータ:** `purchaseDocuments`内に`documentType: "債権譲渡概要"`として存在
- **extractedFactsの内容:** 状態（現在/閉鎖）、会社名など
- **レポートでの判断:**
  - 債権譲渡登記が「閉鎖」または「登記なし」であることを確認（正常）
  - 「現在」の場合は二重譲渡のリスクをレポート

#### 4. 複数請求書の場合の整合性
- **抽出済みデータ:** `purchaseDocuments`に複数の請求書が含まれる可能性
- **レポートでの判断:**
  - 複数の請求書の合計金額とKintoneの総債権額を照合
  - 各請求書の第三債務者とKintone買取情報の整合性チェック

#### 5. 名刺・契約書などの補助資料
- **抽出済みデータ:** `purchaseDocuments`または`collateralDocuments`に含まれる
- **レポートでの判断:**
  - 補助資料として審査の参考情報とする
  - 記載内容と他の書類の整合性チェック

---

## 技術仕様

### 使用AI
- **OCR:** Google Vision API
- **文書分類:** OpenAI GPT-4o
- **買取検証:** OpenAI GPT-4o
- **担保抽出:** OpenAI GPT-4o

### レート制限対策
- OpenAI選択理由: Claude API (50 RPM, 30K TPM) より OpenAI (3,500+ RPM, 90K+ TPM) の方が制限が緩い
- 複数ファイル処理時のレート制限回避

### コスト構造
- Google Vision API: ページ単価 $0.0015
- 文書分類AI: 入力 $0.0000025/token, 出力 $0.00001/token
- 買取検証AI: 入力 $0.000003/token, 出力 $0.000015/token
- 担保抽出AI: 同上

---

## 設計思想

### なぜ買取は照合し、担保は照合しないのか？

**買取請求書:**
- Kintoneの買取情報テーブルは1レコード内に全件含まれる
- Phase 1の時点で全データが取得可能
- 早期に照合することで、基本的な整合性を確認

**担保情報:**
- Kintoneの担保情報テーブルも1レコード内に全件含まれるが、Phase 1では照合しない
- 理由: 担保の照合はレポート全体の文脈で判断すべき（単純な一致/不一致ではない）
- Phase 4で全体を俯瞰してから照合・評価を行う

### 事実ベースの抽出

文書分類AIは「型にはめる」のではなく「何が書いてあったか」を柔軟に記録する設計。
- スキーマは`z.record(z.any())`で柔軟に対応
- ネスト構造も許容
- 存在しない情報は無理に抽出しない

---

## 更新履歴

- 2025-10-04: 初版作成
- Phase 1の処理内容とレポートフェーズへの引き継ぎ事項を明記
